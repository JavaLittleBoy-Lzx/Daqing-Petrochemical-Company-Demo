# 人员同步优化说明

## 问题描述

### 1. 人员重复查询照片
**现象**：日志显示同一个人员（如 ryid=2024538782）的照片被查询了几十次

**原因**：
- Oracle视图中同一个人员有多条记录（每条记录对应一个门禁权限/厂区CQDM）
- 原代码对每条记录都查询一次照片
- 导致大量重复的数据库查询

### 2. 门禁权限映射问题
**现象**：Oracle中的CQDM无法直接用于威尔系统授权

**原因**：
- Oracle使用CQDM编码（如0301）
- 威尔系统使用doorId
- 需要建立映射关系

## 解决方案

### 1. 人员聚合优化（OracleDataService.java）

同一人员的多条记录聚合为一个对象，将所有CQDM合并到 `gatePermissionStr` 字段。

**示例**：
```
原始记录：
- 人员A, CQDM=0301 (化工西门)
- 人员A, CQDM=0302 (化工北门)
- 人员A, CQDM=0304 (化工东门)

聚合后：
- 人员A, gatePermissionStr="0301,0302,0304"
```

### 2. 大门编码映射（GateCodeMappingUtil.java）

新增工具类，将CQDM映射到大门全称：

| CQDM | 大门全称 |
|------|----------|
| 0101 | 炼油南门 |
| 0102 | 炼油南一 |
| 0104 | 炼油西一 |
| 0105 | 炼油西门 |
| 0106 | 炼油东门 |
| 0201 | 化肥西门 |
| 0202 | 化肥北门 |
| 0301 | 化工西门 |
| 0302 | 化工北门 |
| 0304 | 化工东门 |
| 0401 | 化三南门 |
| 0402 | 化三西二 |
| 0501 | 复合肥南门 |
| 0901 | 机修厂西一 |
| 1001 | 指挥内部正门 |
| 1101 | 二罐区正门 |
| 1201 | 一罐区正门 |
| 1301 | 北油库正门 |
| 1401 | 化肥北北门 |
| 1501 | 指挥外部正门 |

### 3. 威尔门禁列表查询（WellPersonService.java）

新增方法：
- `getDoorList()`: 调用 `/api-gating/api-gating/open-gating-door/doorList` 获取门禁列表
- `findDoorIdsByGateName()`: 根据大门名称匹配威尔系统的doorId

### 4. 门禁授权流程（DataSyncServiceImpl.java）

**新流程**：
```
1. 获取威尔门禁列表（缓存）
2. 遍历人员的CQDM列表
3. 通过GateCodeMappingUtil将CQDM转换为大门全称
4. 在威尔门禁列表中匹配placeName，获取doorId
5. 使用匹配到的doorId进行授权
```

**示例**：
```
人员A的CQDM: 0301,0302
    ↓
CQDM映射: 0301→化工西门, 0302→化工北门
    ↓
威尔匹配: 化工西门→doorId=[1,2,3], 化工北门→doorId=[4,5]
    ↓
授权: doorIds=[1,2,3,4,5]
```

## 数据流程

```
Oracle查询 → 50条记录（同一人员，不同CQDM）
    ↓
聚合 → 1个人员对象（gatePermissionStr="0301,0302,0304"）
    ↓
查询照片1次
    ↓
同步人员1次
    ↓
CQDM映射 → 大门全称列表
    ↓
威尔匹配 → doorId列表
    ↓
授权N次（N=匹配到的门禁数量）
```

## 相关文件

- `src/main/java/com/parkingmanage/util/GateCodeMappingUtil.java` - 新增：大门编码映射
- `src/main/java/com/parkingmanage/service/oracle/OracleDataService.java` - 修改：人员聚合
- `src/main/java/com/parkingmanage/service/well/WellPersonService.java` - 修改：门禁列表查询
- `src/main/java/com/parkingmanage/service/sync/impl/DataSyncServiceImpl.java` - 修改：授权逻辑

## 部署步骤

1. **编译代码**（已完成）
   ```bash
   mvn compile -DskipTests
   ```

2. **重启应用**

3. **观察日志**
   - 查看人员聚合日志
   - 查看CQDM到大门名称的映射
   - 查看威尔门禁匹配结果
   - 查看授权日志

## 日志示例

```
人员同步 - 获取到 50 条人员数据（原始记录）
聚合后人员数: 5 人（原始记录: 50 条）
获取到威尔门禁列表，共 20 个门禁
人员[2024538782] CQDM=0301 -> 大门=化工西门 -> doorIds=[1, 2, 3]
人员[2024538782]门禁权限: CQDM=0301,0302 -> doorIds=[1, 2, 3, 4, 5]
```
