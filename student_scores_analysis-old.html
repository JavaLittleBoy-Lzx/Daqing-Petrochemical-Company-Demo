<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>å­¦ç”Ÿæˆç»©åˆ†ææŠ¥å‘Š</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: 'Microsoft YaHei', sans-serif;
            background: #f0f2f5;
            padding: 20px;
            line-height: 1.6;
        }
        
        .container {
            max-width: 1400px;
            margin: 0 auto;
        }
        
        h1 {
            text-align: center;
            color: #333;
            margin-bottom: 10px;
            font-size: 28px;
        }
        
        .subtitle {
            text-align: center;
            color: #666;
            margin-bottom: 30px;
            font-size: 14px;
        }
        
        h2 {
            color: #333;
            margin: 30px 0 15px 0;
            padding-bottom: 10px;
            border-bottom: 2px solid #3498db;
            font-size: 20px;
        }
        
        h3 {
            color: #333;
            font-size: 16px;
            margin-bottom: 10px;
        }
        
        /* ç»Ÿè®¡å¡ç‰‡æ ·å¼ */
        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
            margin-bottom: 30px;
        }
        
        .stat-card {
            background: white;
            padding: 20px;
            border-radius: 10px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
            text-align: center;
        }
        
        .stat-card h3 {
            font-size: 14px;
            color: #666;
            margin-bottom: 10px;
        }
        
        .stat-card .value {
            font-size: 32px;
            font-weight: bold;
            color: #3498db;
            margin-bottom: 5px;
        }
        
        .stat-card .sub {
            font-size: 12px;
            color: #999;
        }
        
        .stat-card.warning .value {
            color: #e74c3c;
        }
        
        .stat-card.success .value {
            color: #27ae60;
        }
        
        /* è¡¨æ ¼æ ·å¼ */
        table {
            width: 100%;
            border-collapse: collapse;
            background: white;
            font-size: 13px;
        }
        
        table th {
            background: #3498db;
            color: white;
            padding: 12px 8px;
            text-align: center;
            font-weight: 600;
        }
        
        table td {
            padding: 10px 8px;
            text-align: center;
            border-bottom: 1px solid #eee;
        }
        
        table tr:hover {
            background: #f8f9fa;
        }
        
        table tr.danger {
            background: #ffe6e6;
        }
        
        table tr.warning-row {
            background: #fff3cd;
        }
        
        table tr.excellent {
            background: #d4edda;
        }
        
        /* å¾½ç« æ ·å¼ */
        .badge {
            display: inline-block;
            padding: 4px 8px;
            border-radius: 4px;
            font-size: 11px;
            font-weight: bold;
        }
        
        .badge-success {
            background: #27ae60;
            color: white;
        }
        
        .badge-info {
            background: #3498db;
            color: white;
        }
        
        .badge-warning {
            background: #f39c12;
            color: white;
        }
        
        .badge-danger {
            background: #e74c3c;
            color: white;
        }
        
        /* åˆ†æåŒºåŸŸæ ·å¼ */
        .analysis-section {
            background: white;
            padding: 20px;
            border-radius: 10px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
            margin-bottom: 20px;
        }
        
        .alert {
            padding: 15px;
            border-radius: 5px;
            margin-bottom: 15px;
        }
        
        .alert-danger {
            background: #ffe6e6;
            border-left: 4px solid #e74c3c;
            color: #721c24;
        }
        
        /* ç½‘æ ¼å¸ƒå±€ */
        .grid-3 {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 15px;
            margin-bottom: 20px;
        }
        
        .charts-grid {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 20px;
            margin-bottom: 20px;
            width: 100%;
        }
        
        .chart-card {
            background: white;
            padding: 20px;
            border-radius: 10px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
            min-height: 350px;
            display: flex;
            flex-direction: column;
            width: 100%;
        }
        
        .chart-card h3 {
            margin-bottom: 15px;
        }
        
        .chart-card.full-width {
            grid-column: 1 / -1;
        }
        
        .chart-card canvas {
            max-height: 300px;
            min-height: 250px;
            width: 100% !important;
            height: 250px !important;
            flex: 1;
        }
        
        .summary-box {
            margin-top: 15px;
            padding: 10px;
            background: #f8f9fa;
            border-radius: 5px;
            font-size: 13px;
            color: #666;
        }
        
        /* è¿›åº¦æ¡æ ·å¼ */
        .progress-bar {
            width: 100%;
            height: 20px;
            background: #eee;
            border-radius: 10px;
            overflow: hidden;
        }
        
        .progress-fill {
            height: 100%;
            transition: width 0.3s;
        }
        
        /* å“åº”å¼è®¾è®¡ */
        @media (max-width: 768px) {
            .stats-grid {
                grid-template-columns: repeat(2, 1fr);
            }
            
            .grid-3, .charts-grid {
                grid-template-columns: 1fr;
            }
            
            h1 {
                font-size: 22px;
            }
            
            h2 {
                font-size: 18px;
            }
        }
    </style>
</head>
<body>
<div class="container">
    <h1>ğŸ“Š å­¦ç”Ÿæˆç»©åˆ†ææŠ¥å‘Š</h1>
    <p class="subtitle">è¯•å·åˆ†æ | æ•°å­¦ + è¯­æ–‡ + è‹±è¯­ | å…±45åå­¦ç”Ÿ</p>

    <!-- æ€»ä½“ç»Ÿè®¡å¡ç‰‡ -->
    <div class="stats-grid">
        <div class="stat-card">
            <h3>å­¦ç”Ÿæ€»æ•°</h3>
            <div class="value">45</div>
        </div>
        <div class="stat-card">
            <h3>æ•°å­¦å¹³å‡åˆ†</h3>
            <div class="value" id="mathAvg">-</div>
            <div class="sub" id="mathInfo">-</div>
        </div>
        <div class="stat-card">
            <h3>è¯­æ–‡å¹³å‡åˆ†</h3>
            <div class="value" id="chineseAvg">-</div>
            <div class="sub" id="chineseInfo">-</div>
        </div>
        <div class="stat-card">
            <h3>è‹±è¯­å¹³å‡åˆ†</h3>
            <div class="value" id="englishAvg">-</div>
            <div class="sub" id="englishInfo">-</div>
        </div>
        <div class="stat-card">
            <h3>ä¸‰ç§‘æ€»åˆ†å¹³å‡</h3>
            <div class="value" id="totalAvg">-</div>
            <div class="sub" id="totalInfo">-</div>
        </div>
        <div class="stat-card warning">
            <h3>ä¸åŠæ ¼äººæ•°</h3>
            <div class="value" id="failCount">-</div>
            <div class="sub">éœ€é‡ç‚¹å…³æ³¨</div>
        </div>
        <div class="stat-card success">
            <h3>ä¼˜ç§€äººæ•°(â‰¥270)</h3>
            <div class="value" id="excellentCount">-</div>
            <div class="sub">ä¸‰ç§‘æ€»åˆ†270+</div>
        </div>
    </div>

    <h2>âš ï¸ é‡ç‚¹å…³æ³¨å­¦ç”Ÿï¼ˆéœ€è¦å¸®åŠ©ï¼‰</h2>
    <div class="analysis-section">
        <div class="alert alert-danger">
            <strong>ğŸš¨ ä¸¥é‡è­¦å‘Šï¼š</strong>ä»¥ä¸‹å­¦ç”Ÿæˆç»©ä¸¥é‡è½åï¼Œéœ€è¦ç«‹å³å¹²é¢„å’Œä¸ªåˆ«è¾…å¯¼
        </div>
        <table id="criticalTable">
            <thead>
                <tr>
                    <th>å§“å</th>
                    <th>æ•°å­¦</th>
                    <th>è¯­æ–‡</th>
                    <th>æ€»åˆ†</th>
                    <th>ç­çº§æ’å</th>
                    <th>é—®é¢˜è¯Šæ–­</th>
                    <th>å»ºè®®</th>
                </tr>
            </thead>
            <tbody></tbody>
        </table>
    </div>

    <h2>ğŸ“‰ å•ç§‘ä¸åŠæ ¼å­¦ç”Ÿåˆ†æ</h2>
    <div class="grid-3">
        <div class="analysis-section">
            <h3 style="color:#e74c3c; margin-bottom:15px;">âŒ æ•°å­¦ä¸åŠæ ¼ (<60åˆ†)</h3>
            <table id="mathFailTable">
                <thead>
                    <tr>
                        <th>å§“å</th>
                        <th>æ•°å­¦</th>
                        <th>å·®è·</th>
                    </tr>
                </thead>
                <tbody></tbody>
            </table>
        </div>
        <div class="analysis-section">
            <h3 style="color:#e74c3c; margin-bottom:15px;">âŒ è¯­æ–‡ä¸åŠæ ¼ (<60åˆ†)</h3>
            <table id="chineseFailTable">
                <thead>
                    <tr>
                        <th>å§“å</th>
                        <th>è¯­æ–‡</th>
                        <th>å·®è·</th>
                    </tr>
                </thead>
                <tbody></tbody>
            </table>
        </div>
        <div class="analysis-section">
            <h3 style="color:#e74c3c; margin-bottom:15px;">âŒ è‹±è¯­ä¸åŠæ ¼ (<60åˆ†)</h3>
            <table id="englishFailTable">
                <thead>
                    <tr>
                        <th>å§“å</th>
                        <th>è‹±è¯­</th>
                        <th>å·®è·</th>
                    </tr>
                </thead>
                <tbody></tbody>
            </table>
        </div>
        <div class="analysis-section">
            <h3 style="color:#f39c12; margin-bottom:15px;">âš ï¸ åç§‘ä¸¥é‡ (ä¸‰ç§‘å·®å€¼>30åˆ†)</h3>
            <table id="imbalanceTable">
                <thead>
                    <tr>
                        <th>å§“å</th>
                        <th>æ•°å­¦</th>
                        <th>è¯­æ–‡</th>
                        <th>è‹±è¯­</th>
                        <th>æœ€å¤§å·®å€¼</th>
                    </tr>
                </thead>
                <tbody></tbody>
            </table>
        </div>
    </div>

    <h2>ğŸ“Š è¯•å·éš¾åº¦åˆ†æ</h2>
    <div class="charts-grid">
        <div class="chart-card">
            <h3>æ•°å­¦æˆç»©åˆ†å¸ƒ</h3>
            <canvas id="mathDistChart"></canvas>
            <div class="summary-box" id="mathSummary"></div>
        </div>
        <div class="chart-card">
            <h3>è¯­æ–‡æˆç»©åˆ†å¸ƒ</h3>
            <canvas id="chineseDistChart"></canvas>
            <div class="summary-box" id="chineseSummary"></div>
        </div>
        <div class="chart-card">
            <h3>è‹±è¯­æˆç»©åˆ†å¸ƒ</h3>
            <canvas id="englishDistChart"></canvas>
            <div class="summary-box" id="englishSummary"></div>
        </div>
    </div>

    <h2>ğŸ“ˆ è¯¦ç»†ç»Ÿè®¡æ•°æ®</h2>
    <div class="analysis-section">
        <table>
            <thead>
                <tr>
                    <th>ç»Ÿè®¡é¡¹</th>
                    <th>æ•°å­¦</th>
                    <th>è¯­æ–‡</th>
                    <th>è‹±è¯­</th>
                    <th>ä¸‰ç§‘æ€»åˆ†</th>
                </tr>
            </thead>
            <tbody id="statsTable"></tbody>
        </table>
    </div>

    <h2>ğŸ† å„åˆ†æ•°æ®µäººæ•°ç»Ÿè®¡</h2>
    <div class="grid-3">
        <div class="analysis-section">
            <h3 style="margin-bottom:15px;">æ•°å­¦åˆ†æ•°æ®µ</h3>
            <table id="mathRangeTable">
                <thead>
                    <tr>
                        <th>åˆ†æ•°æ®µ</th>
                        <th>äººæ•°</th>
                        <th>å æ¯”</th>
                        <th>åˆ†å¸ƒ</th>
                    </tr>
                </thead>
                <tbody></tbody>
            </table>
        </div>
        <div class="analysis-section">
            <h3 style="margin-bottom:15px;">è¯­æ–‡åˆ†æ•°æ®µ</h3>
            <table id="chineseRangeTable">
                <thead>
                    <tr>
                        <th>åˆ†æ•°æ®µ</th>
                        <th>äººæ•°</th>
                        <th>å æ¯”</th>
                        <th>åˆ†å¸ƒ</th>
                    </tr>
                </thead>
                <tbody></tbody>
            </table>
        </div>
        <div class="analysis-section">
            <h3 style="margin-bottom:15px;">æ€»åˆ†åˆ†æ•°æ®µ</h3>
            <table id="totalRangeTable">
                <thead>
                    <tr>
                        <th>åˆ†æ•°æ®µ</th>
                        <th>äººæ•°</th>
                        <th>å æ¯”</th>
                        <th>åˆ†å¸ƒ</th>
                    </tr>
                </thead>
                <tbody></tbody>
            </table>
        </div>
    </div>

    <h2>ğŸ“‹ å…¨ç­æˆç»©æ˜ç»†ï¼ˆæŒ‰æ€»åˆ†æ’åï¼‰</h2>
    <div class="analysis-section">
        <table id="fullTable">
            <thead>
                <tr>
                    <th>æ’å</th>
                    <th>å§“å</th>
                    <th>æ•°å­¦</th>
                    <th>æ•°å­¦è¯„çº§</th>
                    <th>è¯­æ–‡</th>
                    <th>è¯­æ–‡è¯„çº§</th>
                    <th>è‹±è¯­</th>
                    <th>è‹±è¯­è¯„çº§</th>
                    <th>ä¸‰ç§‘æ€»åˆ†</th>
                    <th>ä¸å¹³å‡åˆ†å·®</th>
                    <th>ç»¼åˆè¯„ä»·</th>
                </tr>
            </thead>
            <tbody></tbody>
        </table>
    </div>

    <h2>ğŸ“Š å¯è§†åŒ–å›¾è¡¨</h2>
    <div class="charts-grid">
        <div class="chart-card">
            <h3>æ€»åˆ†åˆ†å¸ƒé¥¼å›¾</h3>
            <canvas id="totalPieChart"></canvas>
        </div>
        <div class="chart-card">
            <h3>æ•°å­¦vsè¯­æ–‡æ•£ç‚¹å›¾ï¼ˆå«è¶‹åŠ¿çº¿ï¼‰</h3>
            <canvas id="scatterChart"></canvas>
        </div>
        <div class="chart-card">
            <h3>å‰10åå­¦ç”Ÿæ€»åˆ†å¯¹æ¯”</h3>
            <canvas id="top10Chart"></canvas>
        </div>
        <div class="chart-card">
            <h3>å10åå­¦ç”Ÿæ€»åˆ†å¯¹æ¯”</h3>
            <canvas id="bottom10Chart"></canvas>
        </div>
        <div class="chart-card">
            <h3>åŠæ ¼ç‡ä¸ä¼˜ç§€ç‡å¯¹æ¯”</h3>
            <canvas id="passRateChart"></canvas>
        </div>
        <div class="chart-card">
            <h3>æˆç»©åˆ†å¸ƒç®±çº¿å›¾</h3>
            <canvas id="boxPlotChart"></canvas>
        </div>
    </div>

    <h2>ğŸ¯ æ·±åº¦è¯•å·åˆ†æ</h2>
    <div class="charts-grid">
        <div class="chart-card">
            <h3>åç§‘åˆ†æé›·è¾¾å›¾</h3>
            <canvas id="radarChart"></canvas>
        </div>
        <div class="chart-card">
            <h3>åç§‘ä¸¥é‡åº¦åˆ†å¸ƒ</h3>
            <canvas id="biasDistChart"></canvas>
        </div>
        <div class="chart-card">
            <h3>åˆ†æ•°æ®µäººæ•°å¯¹æ¯”ï¼ˆæ•°å­¦vsè¯­æ–‡ï¼‰</h3>
            <canvas id="scoreRangeCompareChart"></canvas>
        </div>
        <div class="chart-card">
            <h3>æˆç»©è¿›æ­¥ç©ºé—´åˆ†æ</h3>
            <canvas id="improvementChart"></canvas>
        </div>
        <div class="chart-card">
            <h3>åŒç§‘æˆç»©å¯†åº¦çƒ­åŠ›åˆ†å¸ƒ</h3>
            <canvas id="heatmapChart"></canvas>
        </div>
        <div class="chart-card">
            <h3>è¯•å·åŒºåˆ†åº¦åˆ†æ</h3>
            <canvas id="discriminationChart"></canvas>
        </div>
    </div>
</div>

<script>
// æ·»åŠ é”™è¯¯å¤„ç†
window.addEventListener('error', function(e) {
    console.error('JavaScripté”™è¯¯:', e.message, 'åœ¨', e.filename, 'ç¬¬', e.lineno, 'è¡Œ');
});

console.log('å¼€å§‹åŠ è½½å›¾è¡¨...');

// å­¦ç”Ÿæˆç»©æ•°æ®ï¼ˆä¸‰ç§‘ï¼šæ•°å­¦+è¯­æ–‡+è‹±è¯­ï¼‰
const students = [
    {name: "é‡‘é“­ä¿Š", math: 90, chinese: 83, english: 104},
    {name: "æè´é½", math: 86, chinese: 81, english: 101},
    {name: "é‚±å‘¨ç¿”", math: 91, chinese: 90, english: 102},
    {name: "å¼ å³»ç»®", math: 93, chinese: 91, english: 109},
    {name: "ä»»é£å®‡", math: 92, chinese: 91, english: 103},
    {name: "æ±ªç‰è±ª", math: 95, chinese: 96, english: 105},
    {name: "åˆ˜é²éº’", math: 90, chinese: 81.5, english: 103},
    {name: "é™ˆæ¥·ç‘", math: 60, chinese: 21, english: 88},
    {name: "ææ©æ—­", math: 89, chinese: 85.5, english: 102},
    {name: "ç‹å˜‰äº¨", math: 95, chinese: 96, english: 104},
    {name: "æˆ¿ä¿Šæ±", math: 93, chinese: 95, english: 100},
    {name: "ç‹æŸè½©", math: 97, chinese: 96, english: 104},
    {name: "ææ˜“å®¸", math: 86, chinese: 94, english: 103},
    {name: "åˆ˜é—¯å˜‰", math: 85, chinese: 75.5, english: 105},
    {name: "é«˜åš", math: 79, chinese: 40, english: 101},
    {name: "å¼ æ’ç‘", math: 88, chinese: 90.5, english: 104},
    {name: "æ¨ä¸€å‡¡", math: 89, chinese: 77.5, english: 97},
    {name: "é«˜ç¿”", math: 91, chinese: 64.5, english: 82},
    {name: "è¿ä¿Šåš", math: 91, chinese: 93, english: 96},
    {name: "ç‹æ•åš", math: 38, chinese: 3, english: 41},
    {name: "æ¨ç‘", math: 86, chinese: 83, english: 90},
    {name: "å§œç‘·é’", math: 77, chinese: 89, english: 104},
    {name: "ç‹æç„¶", math: 70, chinese: 62, english: 75},
    {name: "é«˜é›¨è¯º", math: 90, chinese: 94, english: 101},
    {name: "ç‹æºª", math: 98, chinese: 99, english: 105},
    {name: "å•äºˆå¸Œ", math: 76, chinese: 85, english: 100},
    {name: "å¼ å¸†æ¡", math: 91, chinese: 92, english: 109},
    {name: "å§œç‰å½¤", math: 94, chinese: 92.5, english: 95},
    {name: "èµµæ˜åº„", math: 85, chinese: 86.5, english: 88},
    {name: "å´ä¼˜", math: 99, chinese: 94, english: 106},
    {name: "å´”è¯´å…®", math: 71, chinese: 91.5, english: 109},
    {name: "æ¯•è¯­æ¡", math: 76, chinese: 65, english: 95},
    {name: "å¼ æ˜±å®¸", math: 97, chinese: 92.5, english: 105},
    {name: "é˜æœ¨æ™´", math: 92, chinese: 87, english: 102},
    {name: "ææ²æ ¼", math: 96, chinese: 84, english: 104},
    {name: "ææ¢“é½", math: 98, chinese: 83.5, english: 109},
    {name: "æé›…è‹¥", math: 75, chinese: 45, english: 94},
    {name: "æ¢è¯­æ¶µ", math: 79, chinese: 77.5, english: 104},
    {name: "èµµä¸€æ¡", math: 80, chinese: 27, english: 104},
    {name: "å§œä¼Šå“", math: 84, chinese: 89.5, english: 102},
    {name: "å´æ¬£é˜³", math: 88, chinese: 85.5, english: 102},
    {name: "è°¢æ€è•Š", math: 93, chinese: 81.5, english: 105},
    {name: "è·¯ç´«çº", math: 76, chinese: 81.5, english: 101},
    {name: "æ¨æœ¨å­", math: 97, chinese: 93, english: 93},
    {name: "äºå°æ¶µ", math: 97, chinese: 90, english: 106}
];
// è‡ªåŠ¨è®¡ç®—ä¸‰ç§‘æ€»åˆ†
students.forEach(s => s.total = s.math + s.chinese + s.english);

// ç»Ÿè®¡å‡½æ•°
const mathScores = students.map(s => s.math);
const chineseScores = students.map(s => s.chinese);
const englishScores = students.map(s => s.english);
const totalScores = students.map(s => s.total);
const sorted = [...students].sort((a,b) => b.total - a.total);
sorted.forEach((s,i) => s.rank = i + 1);
students.forEach(s => s.rank = sorted.find(x => x.name === s.name).rank);

const sum = arr => arr.reduce((a,b) => a+b, 0);
const avg = arr => sum(arr) / arr.length;
const max = arr => Math.max(...arr);
const min = arr => Math.min(...arr);
const std = arr => { 
    const m = avg(arr); 
    return Math.sqrt(arr.reduce((s,v) => s + (v-m)**2, 0) / arr.length); 
};
const median = arr => { 
    const s = [...arr].sort((a,b)=>a-b); 
    const m = Math.floor(s.length/2); 
    return s.length%2 ? s[m] : (s[m-1]+s[m])/2; 
};

const mathAvg = avg(mathScores);
const chineseAvg = avg(chineseScores);
const englishAvg = avg(englishScores);
const totalAvg = avg(totalScores);

console.log('ç»Ÿè®¡æ•°æ®è®¡ç®—å®Œæˆ:', { mathAvg, chineseAvg, englishAvg, totalAvg });

// æ›´æ–°ç»Ÿè®¡å¡ç‰‡
document.getElementById('mathAvg').textContent = mathAvg.toFixed(1);
document.getElementById('mathInfo').textContent = `æœ€é«˜${max(mathScores)} æœ€ä½${min(mathScores)}`;
document.getElementById('chineseAvg').textContent = chineseAvg.toFixed(1);
document.getElementById('chineseInfo').textContent = `æœ€é«˜${max(chineseScores)} æœ€ä½${min(chineseScores)}`;
document.getElementById('englishAvg').textContent = englishAvg.toFixed(1);
document.getElementById('englishInfo').textContent = `æœ€é«˜${max(englishScores)} æœ€ä½${min(englishScores)}`;
document.getElementById('totalAvg').textContent = totalAvg.toFixed(1);
document.getElementById('totalInfo').textContent = `æœ€é«˜${max(totalScores)} æœ€ä½${min(totalScores)}`;
document.getElementById('failCount').textContent = students.filter(s => s.math < 60 || s.chinese < 60 || s.english < 60).length;
document.getElementById('excellentCount').textContent = students.filter(s => s.total >= 270).length;

// é‡ç‚¹å…³æ³¨å­¦ç”Ÿè¡¨æ ¼ï¼ˆä¸‰ç§‘ç‰ˆæœ¬ï¼‰
const criticalStudents = students.filter(s => s.total < 200 || s.math < 60 || s.chinese < 60 || s.english < 60);
criticalStudents.sort((a,b) => a.total - b.total);
const criticalTbody = document.querySelector('#criticalTable tbody');
criticalStudents.forEach(s => {
    let problems = [], suggestions = [];
    if (s.math < 60) { 
        problems.push('æ•°å­¦ä¸åŠæ ¼'); 
        suggestions.push('åŠ å¼ºæ•°å­¦åŸºç¡€è®­ç»ƒ'); 
    }
    if (s.chinese < 60) { 
        problems.push('è¯­æ–‡ä¸åŠæ ¼'); 
        suggestions.push('åŠ å¼ºè¯­æ–‡é˜…è¯»ç†è§£'); 
    }
    if (s.english < 60) { 
        problems.push('è‹±è¯­ä¸åŠæ ¼'); 
        suggestions.push('åŠ å¼ºè‹±è¯­è¯æ±‡è¯­æ³•'); 
    }
    if (s.total < 150) { 
        problems.push('æ€»åˆ†æä½'); 
        suggestions.push('éœ€è¦ä¸€å¯¹ä¸€è¾…å¯¼'); 
    }
    else if (s.total < 200) { 
        problems.push('æ€»åˆ†åä½'); 
        suggestions.push('éœ€è¦è¯¾åè¡¥ä¹ '); 
    }
    const scores = [s.math, s.chinese, s.english];
    if (Math.max(...scores) - Math.min(...scores) > 30) { 
        problems.push('ä¸¥é‡åç§‘'); 
        suggestions.push('å¹³è¡¡ä¸‰ç§‘å­¦ä¹ æ—¶é—´'); 
    }
    const tr = document.createElement('tr');
    tr.className = s.total < 150 ? 'danger' : 'warning-row';
    tr.innerHTML = `<td><strong>${s.name}</strong></td><td>${s.math}</td><td>${s.chinese}</td><td>${s.total}</td><td>${s.rank}/45</td><td>${problems.join('ã€')}</td><td>${suggestions.join('ï¼›')}</td>`;
    criticalTbody.appendChild(tr);
});

// æ•°å­¦ä¸åŠæ ¼è¡¨æ ¼
const mathFailTbody = document.querySelector('#mathFailTable tbody');
students.filter(s => s.math < 60).sort((a,b) => a.math - b.math).forEach(s => {
    const tr = document.createElement('tr');
    tr.className = 'danger';
    tr.innerHTML = `<td>${s.name}</td><td>${s.math}</td><td>-${60 - s.math}åˆ†</td>`;
    mathFailTbody.appendChild(tr);
});
if (mathFailTbody.children.length === 0) {
    mathFailTbody.innerHTML = '<tr><td colspan="3">æ— </td></tr>';
}

// è¯­æ–‡ä¸åŠæ ¼è¡¨æ ¼
const chineseFailTbody = document.querySelector('#chineseFailTable tbody');
students.filter(s => s.chinese < 60).sort((a,b) => a.chinese - b.chinese).forEach(s => {
    const tr = document.createElement('tr');
    tr.className = 'danger';
    tr.innerHTML = `<td>${s.name}</td><td>${s.chinese}</td><td>-${(60 - s.chinese).toFixed(1)}åˆ†</td>`;
    chineseFailTbody.appendChild(tr);
});
if (chineseFailTbody.children.length === 0) {
    chineseFailTbody.innerHTML = '<tr><td colspan="3">æ— </td></tr>';
}

// è‹±è¯­ä¸åŠæ ¼è¡¨æ ¼
const englishFailTbody = document.querySelector('#englishFailTable tbody');
students.filter(s => s.english < 60).sort((a,b) => a.english - b.english).forEach(s => {
    const tr = document.createElement('tr');
    tr.className = 'danger';
    tr.innerHTML = `<td>${s.name}</td><td>${s.english}</td><td>-${(60 - s.english).toFixed(1)}åˆ†</td>`;
    englishFailTbody.appendChild(tr);
});
if (englishFailTbody.children.length === 0) {
    englishFailTbody.innerHTML = '<tr><td colspan="3">æ— </td></tr>';
}

// åç§‘å­¦ç”Ÿè¡¨æ ¼ï¼ˆä¸‰ç§‘ç‰ˆæœ¬ï¼‰
const imbalanceTbody = document.querySelector('#imbalanceTable tbody');
students.forEach(s => {
    const scores = [s.math, s.chinese, s.english];
    const maxScore = Math.max(...scores);
    const minScore = Math.min(...scores);
    const diff = maxScore - minScore;
    if (diff > 30) {
        const tr = document.createElement('tr');
        tr.className = 'warning-row';
        tr.innerHTML = `<td>${s.name}</td><td>${s.math}</td><td>${s.chinese}</td><td>${s.english}</td><td>${diff.toFixed(1)}</td>`;
        imbalanceTbody.appendChild(tr);
    }
});
if (imbalanceTbody.children.length === 0) {
    imbalanceTbody.innerHTML = '<tr><td colspan="5">æ— </td></tr>';
}

// è¯¦ç»†ç»Ÿè®¡è¡¨æ ¼
const statsTbody = document.querySelector('#statsTable');
const statsData = [
    ['å¹³å‡åˆ†', mathAvg.toFixed(2), chineseAvg.toFixed(2), englishAvg.toFixed(2), totalAvg.toFixed(2)],
    ['æœ€é«˜åˆ†', max(mathScores), max(chineseScores), max(englishScores), max(totalScores)],
    ['æœ€ä½åˆ†', min(mathScores), min(chineseScores), min(englishScores), min(totalScores)],
    ['ä¸­ä½æ•°', median(mathScores).toFixed(1), median(chineseScores).toFixed(1), median(englishScores).toFixed(1), median(totalScores).toFixed(1)],
    ['æ ‡å‡†å·®', std(mathScores).toFixed(2), std(chineseScores).toFixed(2), std(englishScores).toFixed(2), std(totalScores).toFixed(2)],
    ['åŠæ ¼ç‡', (students.filter(s=>s.math>=60).length/45*100).toFixed(1)+'%', (students.filter(s=>s.chinese>=60).length/45*100).toFixed(1)+'%', (students.filter(s=>s.english>=60).length/45*100).toFixed(1)+'%', '-'],
    ['ä¼˜ç§€ç‡(â‰¥90)', (students.filter(s=>s.math>=90).length/45*100).toFixed(1)+'%', (students.filter(s=>s.chinese>=90).length/45*100).toFixed(1)+'%', (students.filter(s=>s.english>=90).length/45*100).toFixed(1)+'%', (students.filter(s=>s.total>=270).length/45*100).toFixed(1)+'%'],
    ['æ»¡åˆ†äººæ•°', students.filter(s=>s.math===100).length, students.filter(s=>s.chinese===100).length, students.filter(s=>s.english===106).length, '-']
];
statsData.forEach(row => {
    const tr = document.createElement('tr');
    tr.innerHTML = row.map((v,i) => i===0 ? `<td><strong>${v}</strong></td>` : `<td>${v}</td>`).join('');
    statsTbody.appendChild(tr);
});

// åˆ†æ•°æ®µç»Ÿè®¡å‡½æ•°
function createRangeTable(tableId, scores, ranges, colors) {
    const tbody = document.querySelector(`#${tableId} tbody`);
    const total = scores.length;
    ranges.forEach(([min, max, label], i) => {
        const count = scores.filter(s => s >= min && s < max).length;
        const pct = (count / total * 100).toFixed(1);
        const tr = document.createElement('tr');
        tr.innerHTML = `<td>${label}</td><td>${count}</td><td>${pct}%</td><td><div class="progress-bar"><div class="progress-fill" style="width:${pct}%;background:${colors[i]}"></div></div></td>`;
        tbody.appendChild(tr);
    });
}

const rangeColors = ['#e74c3c','#f39c12','#f1c40f','#2ecc71','#27ae60'];
createRangeTable('mathRangeTable', mathScores, [[0,60,'ä¸åŠæ ¼(<60)'],[60,70,'60-69'],[70,80,'70-79'],[80,90,'80-89'],[90,101,'ä¼˜ç§€(90+)']], rangeColors);
createRangeTable('chineseRangeTable', chineseScores, [[0,60,'ä¸åŠæ ¼(<60)'],[60,70,'60-69'],[70,80,'70-79'],[80,90,'80-89'],[90,101,'ä¼˜ç§€(90+)']], rangeColors);
createRangeTable('totalRangeTable', totalScores, [[0,180,'<180'],[180,210,'180-209'],[210,240,'210-239'],[240,270,'240-269'],[270,301,'ä¼˜ç§€(270+)']], rangeColors);

// å…¨ç­æˆç»©æ˜ç»†è¡¨ï¼ˆä¸‰ç§‘ç‰ˆæœ¬ï¼‰
const fullTbody = document.querySelector('#fullTable tbody');
function getGrade(score, type) {
    if (type === 'single') {
        if (score >= 95) return '<span class="badge badge-success">ä¼˜ç§€</span>';
        if (score >= 90) return '<span class="badge badge-info">è‰¯å¥½</span>';
        if (score >= 80) return '<span class="badge badge-info">ä¸­ç­‰</span>';
        if (score >= 60) return '<span class="badge badge-warning">åŠæ ¼</span>';
        return '<span class="badge badge-danger">ä¸åŠæ ¼</span>';
    } else {
        if (score >= 270) return '<span class="badge badge-success">ä¼˜ç§€</span>';
        if (score >= 240) return '<span class="badge badge-info">è‰¯å¥½</span>';
        if (score >= 210) return '<span class="badge badge-warning">ä¸­ç­‰</span>';
        if (score >= 180) return '<span class="badge badge-warning">åŠæ ¼</span>';
        return '<span class="badge badge-danger">éœ€å…³æ³¨</span>';
    }
}
sorted.forEach((s, i) => {
    const diff = s.total - totalAvg;
    const tr = document.createElement('tr');
    if (i < 3) tr.className = 'excellent';
    else if (s.total < 200 || s.math < 60 || s.chinese < 60 || s.english < 60) tr.className = 'danger';
    tr.innerHTML = `<td>${i+1}</td><td>${s.name}</td><td>${s.math}</td><td>${getGrade(s.math,'single')}</td><td>${s.chinese}</td><td>${getGrade(s.chinese,'single')}</td><td>${s.english}</td><td>${getGrade(s.english,'single')}</td><td><strong>${s.total}</strong></td><td style="color:${diff>=0?'#27ae60':'#e74c3c'}">${diff>=0?'+':''}${diff.toFixed(1)}</td><td>${getGrade(s.total,'total')}</td>`;
    fullTbody.appendChild(tr);
});

// è¯•å·éš¾åº¦åˆ†æ
document.getElementById('mathSummary').innerHTML = `<strong>æ•°å­¦è¯•å·åˆ†æï¼š</strong>å¹³å‡åˆ†${mathAvg.toFixed(1)}åˆ†ï¼ŒåŠæ ¼ç‡${(students.filter(s=>s.math>=60).length/45*100).toFixed(1)}%ï¼Œä¼˜ç§€ç‡${(students.filter(s=>s.math>=90).length/45*100).toFixed(1)}%ã€‚è¯•å·éš¾åº¦${mathAvg > 85 ? 'åæ˜“' : mathAvg > 75 ? 'é€‚ä¸­' : 'åéš¾'}ã€‚`;
document.getElementById('chineseSummary').innerHTML = `<strong>è¯­æ–‡è¯•å·åˆ†æï¼š</strong>å¹³å‡åˆ†${chineseAvg.toFixed(1)}åˆ†ï¼ŒåŠæ ¼ç‡${(students.filter(s=>s.chinese>=60).length/45*100).toFixed(1)}%ï¼Œä¼˜ç§€ç‡${(students.filter(s=>s.chinese>=90).length/45*100).toFixed(1)}%ã€‚è¯•å·éš¾åº¦${chineseAvg > 85 ? 'åæ˜“' : chineseAvg > 75 ? 'é€‚ä¸­' : 'åéš¾'}ã€‚`;
document.getElementById('englishSummary').innerHTML = `<strong>è‹±è¯­è¯•å·åˆ†æï¼š</strong>å¹³å‡åˆ†${englishAvg.toFixed(1)}åˆ†ï¼ŒåŠæ ¼ç‡${(students.filter(s=>s.english>=60).length/45*100).toFixed(1)}%ï¼Œä¼˜ç§€ç‡${(students.filter(s=>s.english>=90).length/45*100).toFixed(1)}%ã€‚è¯•å·éš¾åº¦${englishAvg > 95 ? 'åæ˜“' : englishAvg > 85 ? 'é€‚ä¸­' : 'åéš¾'}ã€‚`;

// å›¾è¡¨
function getDistribution(scores, ranges) {
    return ranges.map(([min, max, label]) => ({ 
        label, 
        count: scores.filter(s => s >= min && s < max).length 
    }));
}

console.log('å¼€å§‹åˆ›å»ºå›¾è¡¨...');

// æ£€æŸ¥Chart.jsæ˜¯å¦åŠ è½½
if (typeof Chart === 'undefined') {
    console.error('Chart.jsæœªåŠ è½½ï¼');
    alert('Chart.jsåº“åŠ è½½å¤±è´¥ï¼Œè¯·æ£€æŸ¥ç½‘ç»œè¿æ¥ï¼');
} else {
    console.log('Chart.jsç‰ˆæœ¬:', Chart.version);
}

const mathRanges = [[0,60,'ä¸åŠæ ¼'],[60,70,'60-69'],[70,80,'70-79'],[80,90,'80-89'],[90,101,'90+']];
const mathDist = getDistribution(mathScores, mathRanges);
console.log('æ•°å­¦åˆ†å¸ƒå›¾æ•°æ®:', mathDist);

try {
    new Chart(document.getElementById('mathDistChart'), {
    type: 'bar',
    data: { 
        labels: mathDist.map(d => d.label), 
        datasets: [{ 
            label: 'äººæ•°', 
            data: mathDist.map(d => d.count), 
            backgroundColor: rangeColors 
        }] 
    },
    options: { 
        plugins: { legend: { display: false } }, 
        scales: { y: { beginAtZero: true } } 
    }
});
console.log('âœ“ æ•°å­¦åˆ†å¸ƒå›¾åˆ›å»ºæˆåŠŸ');
} catch(e) {
    console.error('âœ— æ•°å­¦åˆ†å¸ƒå›¾åˆ›å»ºå¤±è´¥:', e);
}

const chineseDist = getDistribution(chineseScores, mathRanges);
new Chart(document.getElementById('chineseDistChart'), {
    type: 'bar',
    data: { 
        labels: chineseDist.map(d => d.label), 
        datasets: [{ 
            label: 'äººæ•°', 
            data: chineseDist.map(d => d.count), 
            backgroundColor: rangeColors 
        }] 
    },
    options: { 
        plugins: { legend: { display: false } }, 
        scales: { y: { beginAtZero: true } } 
    }
});

const englishRanges = [[0,60,'ä¸åŠæ ¼'],[60,70,'60-69'],[70,80,'70-79'],[80,90,'80-89'],[90,107,'90+']];
const englishDist = getDistribution(englishScores, englishRanges);
new Chart(document.getElementById('englishDistChart'), {
    type: 'bar',
    data: { 
        labels: englishDist.map(d => d.label), 
        datasets: [{ 
            label: 'äººæ•°', 
            data: englishDist.map(d => d.count), 
            backgroundColor: rangeColors 
        }] 
    },
    options: { 
        plugins: { legend: { display: false } }, 
        scales: { y: { beginAtZero: true } } 
    }
});

const totalRanges = [[0,180,'<180'],[180,210,'180-209'],[210,240,'210-239'],[240,270,'240-269'],[270,301,'270+']];
const totalDist = getDistribution(totalScores, totalRanges);
new Chart(document.getElementById('totalPieChart'), {
    type: 'doughnut',
    data: { 
        labels: totalDist.map(d => `${d.label} (${d.count}äºº)`), 
        datasets: [{ 
            data: totalDist.map(d => d.count), 
            backgroundColor: rangeColors 
        }] 
    }
});

new Chart(document.getElementById('scatterChart'), {
    type: 'scatter',
    data: { 
        datasets: [
            { 
                label: 'å­¦ç”Ÿ', 
                data: students.map(s => ({x: s.math, y: s.chinese, name: s.name})), 
                backgroundColor: students.map(s => s.total < 200 ? '#e74c3c' : '#3498db'), 
                pointRadius: 6 
            },
            {
                label: 'è¶‹åŠ¿çº¿',
                data: [{x: 0, y: 0}, {x: 100, y: 100}],
                type: 'line',
                borderColor: '#95a5a6',
                borderWidth: 2,
                borderDash: [5, 5],
                pointRadius: 0,
                fill: false
            }
        ] 
    },
    options: { 
        scales: { 
            x: { title: { display: true, text: 'æ•°å­¦' }, min: 0, max: 100 }, 
            y: { title: { display: true, text: 'è¯­æ–‡' }, min: 0, max: 100 } 
        }, 
        plugins: { 
            tooltip: { 
                callbacks: { 
                    label: ctx => {
                        if (ctx.datasetIndex === 0) {
                            return `${students[ctx.dataIndex].name}: æ•°å­¦${ctx.raw.x}, è¯­æ–‡${ctx.raw.y}`;
                        }
                        return '';
                    }
                } 
            } 
        } 
    }
});

// å‰10åå­¦ç”Ÿæ€»åˆ†å¯¹æ¯”
const top10 = sorted.slice(0, 10);
new Chart(document.getElementById('top10Chart'), {
    type: 'bar',
    data: { 
        labels: top10.map(s => s.name), 
        datasets: [{ 
            label: 'æ€»åˆ†', 
            data: top10.map(s => s.total), 
            backgroundColor: '#27ae60'
        }] 
    },
    options: { 
        indexAxis: 'y',
        plugins: { legend: { display: false } }, 
        scales: { x: { min: 260, max: 310 } } 
    }
});

// å10åå­¦ç”Ÿæ€»åˆ†å¯¹æ¯”
const bottom10 = sorted.slice(-10).reverse();
new Chart(document.getElementById('bottom10Chart'), {
    type: 'bar',
    data: { 
        labels: bottom10.map(s => s.name), 
        datasets: [{ 
            label: 'æ€»åˆ†', 
            data: bottom10.map(s => s.total), 
            backgroundColor: bottom10.map(s => s.total < 200 ? '#e74c3c' : '#f39c12')
        }] 
    },
    options: { 
        indexAxis: 'y',
        plugins: { legend: { display: false } }, 
        scales: { x: { min: 0, max: 310 } } 
    }
});

// åŠæ ¼ç‡ä¸ä¼˜ç§€ç‡å¯¹æ¯”
const mathPassRate = students.filter(s => s.math >= 60).length / 45 * 100;
const chinesePassRate = students.filter(s => s.chinese >= 60).length / 45 * 100;
const englishPassRate = students.filter(s => s.english >= 60).length / 45 * 100;
const mathExcellentRate = students.filter(s => s.math >= 90).length / 45 * 100;
const chineseExcellentRate = students.filter(s => s.chinese >= 90).length / 45 * 100;
const englishExcellentRate = students.filter(s => s.english >= 90).length / 45 * 100;

new Chart(document.getElementById('passRateChart'), {
    type: 'bar',
    data: { 
        labels: ['åŠæ ¼ç‡(â‰¥60)', 'ä¼˜ç§€ç‡(â‰¥90)'],
        datasets: [
            { label: 'æ•°å­¦', data: [mathPassRate, mathExcellentRate], backgroundColor: '#3498db' },
            { label: 'è¯­æ–‡', data: [chinesePassRate, chineseExcellentRate], backgroundColor: '#e74c3c' },
            { label: 'è‹±è¯­', data: [englishPassRate, englishExcellentRate], backgroundColor: '#9b59b6' }
        ]
    },
    options: { 
        plugins: { legend: { position: 'top' } }, 
        scales: { y: { max: 100, ticks: { callback: v => v + '%' } } } 
    }
});

// æˆç»©åˆ†å¸ƒç®±çº¿å›¾ï¼ˆä½¿ç”¨æŸ±çŠ¶å›¾æ¨¡æ‹Ÿï¼‰
const getQuartile = (arr, q) => {
    const sorted = [...arr].sort((a, b) => a - b);
    const pos = (sorted.length - 1) * q;
    const base = Math.floor(pos);
    const rest = pos - base;
    if (sorted[base + 1] !== undefined) {
        return sorted[base] + rest * (sorted[base + 1] - sorted[base]);
    } else {
        return sorted[base];
    }
};

const mathQuartiles = [
    min(mathScores), 
    getQuartile(mathScores, 0.25), 
    median(mathScores), 
    getQuartile(mathScores, 0.75), 
    max(mathScores)
];
const chineseQuartiles = [
    min(chineseScores), 
    getQuartile(chineseScores, 0.25), 
    median(chineseScores), 
    getQuartile(chineseScores, 0.75), 
    max(chineseScores)
];
const englishQuartiles = [
    min(englishScores), 
    getQuartile(englishScores, 0.25), 
    median(englishScores), 
    getQuartile(englishScores, 0.75), 
    max(englishScores)
];

new Chart(document.getElementById('boxPlotChart'), {
    type: 'bar',
    data: { 
        labels: ['æœ€ä½åˆ†', 'ä¸‹å››åˆ†ä½', 'ä¸­ä½æ•°', 'ä¸Šå››åˆ†ä½', 'æœ€é«˜åˆ†'],
        datasets: [
            { label: 'æ•°å­¦', data: mathQuartiles, backgroundColor: '#3498db' },
            { label: 'è¯­æ–‡', data: chineseQuartiles, backgroundColor: '#e74c3c' },
            { label: 'è‹±è¯­', data: englishQuartiles, backgroundColor: '#9b59b6' }
        ]
    },
    options: { 
        plugins: { legend: { position: 'top' } }, 
        scales: { y: { min: 0, max: 106 } } 
    }
});

// ========== æ·±åº¦è¯•å·åˆ†æå›¾è¡¨ ==========

// 1. åç§‘åˆ†æé›·è¾¾å›¾
new Chart(document.getElementById('radarChart'), {
    type: 'radar',
    data: {
        labels: ['å¹³å‡åˆ†', 'åŠæ ¼ç‡', 'ä¼˜ç§€ç‡', 'æœ€é«˜åˆ†', 'ä¸­ä½æ•°'],
        datasets: [
            {
                label: 'æ•°å­¦',
                data: [
                    mathAvg,
                    mathPassRate,
                    mathExcellentRate,
                    max(mathScores),
                    median(mathScores)
                ],
                backgroundColor: 'rgba(52, 152, 219, 0.2)',
                borderColor: '#3498db',
                borderWidth: 2
            },
            {
                label: 'è¯­æ–‡',
                data: [
                    chineseAvg,
                    chinesePassRate,
                    chineseExcellentRate,
                    max(chineseScores),
                    median(chineseScores)
                ],
                backgroundColor: 'rgba(231, 76, 60, 0.2)',
                borderColor: '#e74c3c',
                borderWidth: 2
            },
            {
                label: 'è‹±è¯­',
                data: [
                    englishAvg,
                    englishPassRate,
                    englishExcellentRate,
                    max(englishScores),
                    median(englishScores)
                ],
                backgroundColor: 'rgba(155, 89, 182, 0.2)',
                borderColor: '#9b59b6',
                borderWidth: 2
            }
        ]
    },
    options: {
        scales: {
            r: {
                beginAtZero: true,
                max: 106
            }
        },
        plugins: {
            legend: { position: 'top' }
        }
    }
});

// 2. åç§‘ä¸¥é‡åº¦åˆ†å¸ƒï¼ˆä¸‰ç§‘æœ€å¤§å·®å€¼ï¼‰
const biasData = students.map(s => {
    const scores = [s.math, s.chinese, s.english];
    return Math.max(...scores) - Math.min(...scores);
});
const biasRanges = [
    [0, 10, 'éå¸¸å‡è¡¡(<10)'],
    [10, 20, 'è¾ƒå‡è¡¡(10-19)'],
    [20, 30, 'è½»å¾®åç§‘(20-29)'],
    [30, 40, 'åç§‘(30-39)'],
    [40, 50, 'ä¸¥é‡åç§‘(40-49)'],
    [50, 100, 'æåº¦åç§‘(â‰¥50)']
];
const biasCounts = biasRanges.map(([min, max]) => 
    biasData.filter(d => d >= min && d < max).length
);

new Chart(document.getElementById('biasDistChart'), {
    type: 'bar',
    data: {
        labels: biasRanges.map(r => r[2]),
        datasets: [{
            label: 'å­¦ç”Ÿäººæ•°',
            data: biasCounts,
            backgroundColor: [
                '#27ae60', '#2ecc71', '#f1c40f',
                '#f39c12', '#e74c3c', '#c0392b'
            ]
        }]
    },
    options: {
        plugins: { legend: { display: false } },
        scales: { y: { beginAtZero: true, ticks: { stepSize: 2 } } }
    }
});

// 3. åˆ†æ•°æ®µäººæ•°å¯¹æ¯”ï¼ˆä¸‰ç§‘ï¼‰
const scoreRanges = [[0,60,'<60'],[60,70,'60-69'],[70,80,'70-79'],[80,90,'80-89'],[90,107,'90+']];
const mathRangeCounts = scoreRanges.map(([min, max]) => 
    mathScores.filter(s => s >= min && s < max).length
);
const chineseRangeCounts = scoreRanges.map(([min, max]) => 
    chineseScores.filter(s => s >= min && s < max).length
);
const englishRangeCounts = scoreRanges.map(([min, max]) => 
    englishScores.filter(s => s >= min && s < max).length
);

new Chart(document.getElementById('scoreRangeCompareChart'), {
    type: 'bar',
    data: {
        labels: scoreRanges.map(r => r[2]),
        datasets: [
            { label: 'æ•°å­¦', data: mathRangeCounts, backgroundColor: '#3498db' },
            { label: 'è¯­æ–‡', data: chineseRangeCounts, backgroundColor: '#e74c3c' },
            { label: 'è‹±è¯­', data: englishRangeCounts, backgroundColor: '#9b59b6' }
        ]
    },
    options: {
        plugins: { legend: { position: 'top' } },
        scales: { y: { beginAtZero: true, ticks: { stepSize: 2 } } }
    }
});

// 4. æˆç»©è¿›æ­¥ç©ºé—´åˆ†æï¼ˆ300åˆ†åˆ¶ï¼‰
const improvementLevels = [
    students.filter(s => s.total < 180).length,  // éœ€é‡ç‚¹å…³æ³¨
    students.filter(s => s.total >= 180 && s.total < 210).length,  // æœ‰è¾ƒå¤§æå‡ç©ºé—´
    students.filter(s => s.total >= 210 && s.total < 240).length,  // æœ‰æå‡ç©ºé—´
    students.filter(s => s.total >= 240 && s.total < 270).length,  // ç¨³å®šå‘æŒ¥
    students.filter(s => s.total >= 270).length   // ä¼˜ç§€
];

new Chart(document.getElementById('improvementChart'), {
    type: 'bar',
    data: {
        labels: ['éœ€é‡ç‚¹å…³æ³¨\n(<180)', 'è¾ƒå¤§æå‡ç©ºé—´\n(180-209)', 'æœ‰æå‡ç©ºé—´\n(210-239)', 'ç¨³å®šå‘æŒ¥\n(240-269)', 'ä¼˜ç§€\n(â‰¥270)'],
        datasets: [{
            label: 'å­¦ç”Ÿäººæ•°',
            data: improvementLevels,
            backgroundColor: ['#e74c3c', '#f39c12', '#f1c40f', '#3498db', '#27ae60']
        }]
    },
    options: {
        plugins: { legend: { display: false } },
        scales: { y: { beginAtZero: true, ticks: { stepSize: 2 } } }
    }
});

// 5. åŒç§‘æˆç»©å¯†åº¦çƒ­åŠ›åˆ†å¸ƒï¼ˆæ•°å­¦vsè¯­æ–‡ï¼Œç”¨æ°”æ³¡å›¾æ¨¡æ‹Ÿï¼‰
const heatmapData = [];
for (let m = 0; m <= 100; m += 20) {
    for (let c = 0; c <= 100; c += 20) {
        const count = students.filter(s => 
            s.math >= m && s.math < m + 20 && 
            s.chinese >= c && s.chinese < c + 20
        ).length;
        if (count > 0) {
            heatmapData.push({x: m + 10, y: c + 10, r: count * 3});
        }
    }
}

new Chart(document.getElementById('heatmapChart'), {
    type: 'bubble',
    data: {
        datasets: [{
            label: 'å­¦ç”Ÿå¯†åº¦',
            data: heatmapData,
            backgroundColor: 'rgba(52, 152, 219, 0.6)',
            borderColor: '#3498db'
        }]
    },
    options: {
        scales: {
            x: { title: { display: true, text: 'æ•°å­¦åˆ†æ•°æ®µ' }, min: 0, max: 100 },
            y: { title: { display: true, text: 'è¯­æ–‡åˆ†æ•°æ®µ' }, min: 0, max: 100 }
        },
        plugins: {
            tooltip: {
                callbacks: {
                    label: ctx => `è¯¥åŒºåŸŸçº¦ ${Math.round(ctx.raw.r / 3)} äºº`
                }
            }
        }
    }
});

// 6. è¯•å·åŒºåˆ†åº¦åˆ†æï¼ˆç´¯è®¡åˆ†å¸ƒæ›²çº¿ - ä¸‰ç§‘ï¼‰
const mathSorted = [...mathScores].sort((a, b) => a - b);
const chineseSorted = [...chineseScores].sort((a, b) => a - b);
const englishSorted = [...englishScores].sort((a, b) => a - b);
const cumulativeMath = mathSorted.map((_, i) => ((i + 1) / mathSorted.length * 100));
const cumulativeChinese = chineseSorted.map((_, i) => ((i + 1) / chineseSorted.length * 100));
const cumulativeEnglish = englishSorted.map((_, i) => ((i + 1) / englishSorted.length * 100));

new Chart(document.getElementById('discriminationChart'), {
    type: 'line',
    data: {
        datasets: [
            {
                label: 'æ•°å­¦ç´¯è®¡åˆ†å¸ƒ',
                data: mathSorted.map((score, i) => ({x: score, y: cumulativeMath[i]})),
                borderColor: '#3498db',
                backgroundColor: 'rgba(52, 152, 219, 0.1)',
                fill: true,
                tension: 0.4
            },
            {
                label: 'è¯­æ–‡ç´¯è®¡åˆ†å¸ƒ',
                data: chineseSorted.map((score, i) => ({x: score, y: cumulativeChinese[i]})),
                borderColor: '#e74c3c',
                backgroundColor: 'rgba(231, 76, 60, 0.1)',
                fill: true,
                tension: 0.4
            },
            {
                label: 'è‹±è¯­ç´¯è®¡åˆ†å¸ƒ',
                data: englishSorted.map((score, i) => ({x: score, y: cumulativeEnglish[i]})),
                borderColor: '#9b59b6',
                backgroundColor: 'rgba(155, 89, 182, 0.1)',
                fill: true,
                tension: 0.4
            }
        ]
    },
    options: {
        scales: {
            x: { title: { display: true, text: 'åˆ†æ•°' }, min: 0, max: 106 },
            y: { title: { display: true, text: 'ç´¯è®¡ç™¾åˆ†æ¯”(%)' }, min: 0, max: 100 }
        },
        plugins: {
            legend: { position: 'top' }
        }
    }
});
</script>
</body>
</html>
