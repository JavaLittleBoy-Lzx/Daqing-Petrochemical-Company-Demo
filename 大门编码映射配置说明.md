# 大门编码映射配置说明

## 问题描述

系统在处理威尔门禁记录时，遇到带有通道编号的大门名称（如"化工西门9号出口"），导致记录无法写入Oracle数据库。

**错误日志示例：**
```
WARN  com.parkingmanage.util.GateCodeMapper.getPersonGateCode:162 - 未找到人员表大门编码: 化工西门9号出口
WARN  c.p.service.oracle.OracleRecordWriteService.writePersonRecord:241 - 未找到大门编码，跳过写入: 大门名称=化工西门9号出口
```

**问题原因：**
- 威尔门禁系统返回的是通道名称，包含具体的通道编号（如"9号"）
- 实际的大门名称应该是去除通道编号后的名称（如"化工西门"）
- 原有逻辑只去除"入口"、"出口"，没有去除通道编号

## 解决方案

修改 `GateCodeMapper.java` 中的大门名称清理逻辑，自动去除通道编号。

### 修改内容

**修改前：**
```java
// 去除可能的"入口"、"出口"等后缀
String cleanName = gateName.trim()
        .replace("入口", "")
        .replace("出口", "")
        .trim();
```

**修改后：**
```java
// 清理大门名称：
// 1. 去除"入口"、"出口"等后缀
// 2. 去除数字编号（如"9号"、"1号"等）
String cleanName = gateName.trim()
        .replace("入口", "")
        .replace("出口", "")
        .replaceAll("\\d+号", "")  // 去除数字+号（如：9号、1号）
        .trim();
```

### 处理示例

| 原始通道名称 | 清理后的大门名称 | 匹配结果 |
|------------|----------------|---------|
| 化工西门9号出口 | 化工西门 | ✅ 匹配成功 |
| 炼油南一1号入口 | 炼油南一 | ✅ 匹配成功 |
| 化肥北门出口 | 化肥北门 | ✅ 匹配成功 |
| 复合肥南门 | 复合肥南门 | ✅ 匹配成功 |

### 修改范围

**修改文件：** `GateCodeMapper.java`

**修改方法：**
1. `getVehicleGateCode()` - 车辆表大门编码查询
2. `getPersonGateCode()` - 人员表大门编码查询

**影响功能：**
- 所有车辆进出场记录的大门编码匹配
- 所有人员进出场记录的大门编码匹配

## 大门名称处理规则

系统会按以下顺序清理大门名称：

1. **去除"入口"后缀**
   - "化工西门入口" → "化工西门"

2. **去除"出口"后缀**
   - "化工西门出口" → "化工西门"

3. **去除通道编号（数字+号）**
   - "化工西门9号" → "化工西门"
   - "炼油南一1号" → "炼油南一"

4. **去除首尾空格**
   - " 化工西门 " → "化工西门"

**完整示例：**
```
"化工西门9号出口" 
  → 去除"出口" → "化工西门9号"
  → 去除"9号" → "化工西门"
  → 去除空格 → "化工西门"
  → 匹配成功 ✅
```

## 优势

1. **自动适配通道编号**：无需为每个通道单独配置映射
2. **减少配置维护**：只需配置大门名称，不需要配置每个通道
3. **灵活性强**：支持任意数字编号的通道（1号、2号、9号等）
4. **向后兼容**：不影响原有的大门名称匹配

## 测试建议

1. 重启应用服务
2. 等待门禁记录同步任务执行
3. 检查日志，确认不再出现"未找到大门编码"警告
4. 查询Oracle数据库，确认记录正常写入
5. 验证不同通道编号的记录都能正确匹配

## 修改时间

2026-01-15

## 相关文件

- `GateCodeMapper.java` - 大门编码映射配置
- `OracleRecordWriteService.java` - Oracle记录写入服务
- `GateRecordSyncTask.java` - 门禁记录同步任务
