# 大庆石化数据同步服务修改总结

## 修改日期
2026-01-16

---

## 修改概览

本次修改主要解决了以下问题：

1. **Oracle SQL 类型转换问题** - VARCHAR2 日期字段隐式转换失败
2. **VIP 类型智能匹配** - 只使用威尔系统实际存在的 VIP 类型
3. **车辆状态取值问题** - 使用最新记录的 DQZT 状态
4. **人员注销处理** - DQZT="D" 时删除人员
5. **人员授权方式统一** - 所有人员统一使用临时时段授权
6. **VIP 时间比较逻辑优化** - 区分 AKE > Oracle、AKE = Oracle、AKE < Oracle 三种情况

---

## 详细修改内容

### 1. Oracle SQL 类型转换问题修复

**问题：** Oracle 数据库中的 CZSJ、EDIT_DATETIME 字段为 VARCHAR2 类型，直接与字符串参数比较时导致隐式类型转换失败。

**错误信息：** `ORA-17132: 请求的转换无效`

**解决方案：** 使用 `TO_TIMESTAMP` 显式转换

**修改位置：** `OracleDataService.java`

| 行号 | 方法 | 修改内容 |
|------|------|---------|
| 79 | `getLatestPersonData()` | `TO_TIMESTAMP(CZSJ, 'YYYY-MM-DD HH24:MI:SS') > TO_TIMESTAMP(?, ...)` |
| 486 | `getLatestVehicleData()` | `TO_TIMESTAMP(CZSJ, 'YYYY-MM-DD HH24:MI:SS') > TO_TIMESTAMP(?, ...)` |
| 297 | `getUpdatedPhotoPersonIds()` | `TO_TIMESTAMP(EDIT_DATETIME, ...) > TO_TIMESTAMP(?, ...)` |
| 310 | `getUpdatedPhotoPersonIds()` | `TO_TIMESTAMP(EDIT_DATETIME, ...) > TO_TIMESTAMP(?, ...)` |
| 323 | `getUpdatedPhotoPersonIds()` | `TO_TIMESTAMP(EDIT_DATETIME, ...) > TO_TIMESTAMP(?, ...)` |

---

### 2. VIP 类型智能匹配功能

**问题：** Oracle 查询到的厂区名称（如"复合肥南"、"化三南"、"炼油西一"等）直接拼接成 VIP 类型名称，导致在威尔系统中找不到对应的类型。

**解决方案：** 只使用威尔系统中实际存在的 VIP 类型，过滤掉不存在的门名称。

**修改位置：** `VipTypeMatcherUtil.java`、`DataSyncServiceImpl.java`

**威尔系统实际存在的 VIP 类型：**
```
单门VIP：
- 化工西VIP
- 化肥西VIP
- 复合肥南VIP

双门VIP组合：
- 化工西化肥西VIP
- 化工西复合肥南VIP
- 化肥西复合肥南VIP

三门VIP组合：
- 化工西化肥西复合肥南VIP
```

**匹配逻辑：**
```java
// 过滤出有效的门权限（只保留威尔系统中存在的门）
Set<String> validPermissions = new LinkedHashSet<>();
for (String permission : oraclePermissions) {
    if (validAkeGateNames.contains(permission)) {
        validPermissions.add(permission);
    }
}

// 找到包含最多有效权限的已知 VIP 类型
String bestMatch = findBestMatchVipTypeFromKnown(validPermissions);
```

**示例：**
```
Oracle权限: [复合肥南, 化肥西, 化三南, 炼油西一, 机修厂西一, 化工北]
     ↓ 过滤无效权限
有效权限: [复合肥南, 化肥西]
     ↓ 最佳匹配
结果: "化肥西复合肥南VIP"
```

---

### 3. 车辆状态取值问题修复

**问题：** 同一车牌有多条记录时，只使用第一条记录的 remark（DQZT 状态），导致最新的注销状态无法被检测到。

**解决方案：** 每次添加记录时都更新 remark，确保使用最新记录的 DQZT 状态。

**修改位置：** `GroupedVehicleInfo.java`

```java
// 修改前：只在第一条记录时初始化 remark
if (originalRecords.isEmpty()) {
    this.remark = record.getRemark();
}

// 修改后：每次都更新 remark（使用最新记录的 DQZT 状态）
this.remark = record.getRemark();
```

---

### 4. 人员注销处理逻辑

**问题：** Oracle 中 DQZT="D"（注销）的人员仍然同步到威尔系统。

**解决方案：** 同步前先检查 DQZT 状态，注销人员调用威尔删除接口。

**威尔删除接口：**
```
POST /api-general/api-general/open-user/batch/delete
Content-Type: application/json

["ryid1", "ryid2", ...]
```

**修改位置：**
- `application.yml` - 添加 `person-delete-url` 配置
- `WellPersonService.java` - 添加 `batchDeletePerson(List<String> sourceNos)` 方法
- `DataSyncServiceImpl.java` - 修改 `syncPersonData()` 方法

**处理流程：**
```
从 Oracle 获取人员数据
     ↓
按 remark (DQZT) 分离
     ↓
┌────┴────┐
↓         ↓
D="D"    D≠"D"
↓         ↓
删除人员  同步人员+人脸+授权
```

---

### 5. 人员授权方式统一

**问题：** 之前区分正式员工（使用时段规则）和临时员工（使用临时时段）。

**解决方案：** 统一使用临时时段授权接口。

**威尔临时时段授权接口：**
```
/api-gating/api-gating/open-gating-single-grant/batch/insert-or-update
```

**修改位置：** `DataSyncServiceImpl.java`

| 人员类型 | 修改前 | 修改后 |
|---------|--------|--------|
| 正式职工 | 时段规则授权 | 临时时段授权 |
| 子女工 | 时段规则授权 | 临时时段授权 |
| 长期外用工 | 临时时段授权 | 临时时段授权 |
| 施工人员 | 临时时段授权 | 临时时段授权 |
| 外来人员 | 临时时段授权 | 临时时段授权 |

---

### 6. VIP 时间比较逻辑优化

**问题：** 之前只区分"时间相同"和"时间不同"两种情况，时间不同时统一调用续费接口。

**限制：** 续费接口只能延长时间，如果 AKE 的时间范围比 Oracle 大，续费会失败。

**解决方案：** 区分三种情况：
- AKE > Oracle：先退费再开通
- AKE = Oracle：不操作
- AKE < Oracle：续费

**修改位置：** `DataSyncServiceImpl.java` 的 `checkAndUpdateVipTime()` 方法

**新增方法：** `compareTime(String time1, String time2)`

**判断逻辑：**
```java
if (时间完全相同) {
    不操作;
} else if (ACE结束时间 > Oracle结束时间) {
    先退费 → 再开通;
} else {
    续费;
}
```

**示例场景：**
```
场景1：ACE 范围更大（需要退费重开）
Oracle: 2025-01-01 ~ 2025-06-30
AKE:    2025-01-01 ~ 2025-12-31
判断：   AKE结束(12月) > Oracle结束(6月)
操作：   先退费 → 再开通

场景2：时间相同（不操作）
Oracle: 2025-01-01 ~ 2025-12-31
AKE:    2025-01-01 ~ 2025-12-31
操作：   不操作

场景3：AKE 范围更小（续费）
Oracle: 2025-01-01 ~ 2025-12-31
AKE:    2025-01-01 ~ 2025-06-30
判断：   AKE结束(6月) < Oracle结束(12月)
操作：   续费到 2025-12-31
```

---

## 黑名单逻辑（无变化）

黑名单逻辑已经是正确的，保持不变：

| 场景 | 操作 |
|------|------|
| DQZT="D" | 删除 |
| 无现有黑名单 | 添加 |
| 有现有黑名单 | 先删除 → 再添加 |

---

## 文件清单

### 修改的文件

| 文件 | 修改内容 |
|------|---------|
| `application.yml` | 添加威尔删除人员接口配置 |
| `OracleDataService.java` | SQL 类型转换修复（5处） |
| `GroupedVehicleInfo.java` | remark 字段使用最新记录 |
| `VipTypeMatcherUtil.java` | 更新 VIP 类型列表，新增智能匹配方法 |
| `WellPersonService.java` | 新增删除人员方法 |
| `DataSyncServiceImpl.java` | VIP/黑名单智能匹配、人员注销处理、VIP时间比较逻辑优化 |

### 新增的 JAR 包

```
D:\Daqing Petrochemical Company Demo\target\parkingmanage-0.0.1-SNAPSHOT.jar
```

---

## 接口调用说明

### 威尔系统接口

| 接口 | 用途 | 说明 |
|------|------|------|
| `/open-user/batch/insert-or-update` | 新增/修改人员 | - |
| `/open-user/batch/delete` | 删除人员 | 参数为 RYID 字符串数组 |
| `/open-face/batch/insert` | 添加人脸照片 | - |
| `/open-gating-single-grant/batch/insert-or-update` | 临时时段授权 | 统一使用此接口 |
| `/open-gating-grant/batch/insert-or-update` | 时段规则授权 | 不再使用 |

### AKE 停车系统接口

| 接口 | 用途 | 说明 |
|------|------|------|
| `GET_VIP_TICKET` | 查询 VIP 票 | - |
| `OPEN_VIP_TICKET` | 开通 VIP 月票 | - |
| `REFUND_VIP_TICKET` | VIP 退费 | - |
| `RENEW_VIP_TICKET` | VIP 续费 | 只能延长时间 |
| `GET_BLACK_LIST_CAR` | 查询黑名单 | 获取全部后筛选 |
| `ADD_BLACK_LIST_CAR` | 添加黑名单 | - |
| `DELETE_BLACK_LIST_CAR` | 删除黑名单 | - |

---

## 字段映射关系

### Oracle 字段映射

| Oracle 字段 | Java 字段 | 威尔接口 | 说明 |
|------------|----------|---------|------|
| RYID | employeeNo | sourceNo | 人员ID/员工编号（唯一约束） |
| DQZT | remark | - | 当前状态代码："D"=注销 |
| DQZTNAME | remark | - | 当前状态名称 |
| CZSJ | - | - | 操作时间（用于增量同步） |
| KYXQKSSJ | validStartTime | begin_time | 有效期开始时间 |
| KYXQJSSJ | validEndTime | end_time | 有效期结束时间 |
| CQDM | - | - | 厂区代码 |
| CQDMNAME | orgName | - | 厂区名称 |

---

## 部署说明

1. 停止当前运行的服务
2. 备份当前的 JAR 包
3. 替换为新的 JAR 包：
   ```
   D:\Daqing Petrochemical Company Demo\target\parkingmanage-0.0.1-SNAPSHOT.jar
   ```
4. 重启服务
5. 检查日志确认启动成功

---

## 注意事项

1. **VIP 类型匹配**：确保威尔系统中已配置好所有 VIP 类型组合
2. **人员删除**：威尔系统删除人员后，人脸和授权会自动清理
3. **时间比较**：续费接口只能延长时间，不能缩短时间
4. **黑名单查询**：`GET_BLACK_LIST_CAR` 接口不支持按车牌号过滤，需要获取全部后筛选
5. **状态字段**：remark 字段存储的是 DQZTNAME（状态名称），DQZT="D" 时 remark="D"

---

## 版本信息

- **项目名称**：大庆石化数据同步服务
- **版本**：0.0.1-SNAPSHOT
- **Spring Boot 版本**：2.5.5
- **Java 版本**：8
