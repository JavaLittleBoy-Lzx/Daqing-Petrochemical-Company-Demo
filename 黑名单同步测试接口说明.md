# 车辆黑名单同步测试接口说明

## 概述

为了测试车辆黑名单同步功能，我们提供了5个测试接口，可以模拟黑名单同步的各种场景。

## 测试接口列表

### 1. 查询车辆黑名单状态

**接口地址：** `GET /api/sync/test/blacklist/query`

**功能：** 查询指定车牌号的黑名单状态

**参数：**
- `plateNumber` (必填): 车牌号，如 "黑A12345"

**示例：**
```
GET http://localhost:8080/api/sync/test/blacklist/query?plateNumber=黑A12345
```

**返回示例：**
```json
{
  "success": true,
  "code": 20000,
  "message": "📋 黑名单信息\n车牌号: 黑A12345\n类型名称: 请停车检查（化工西化肥西）\n车主: 测试车主\n原因: 请停车检查\n永久标志: 临时\n时间段: 2026-01-15 00:00:00~2026-12-31 23:59:59\n添加人: 系统同步\n添加时间: 2026-01-15 08:30:00\n操作人: 系统同步\n操作时间: 2026-01-15 08:30:00"
}
```

---

### 2. 测试添加新黑名单（场景1）

**接口地址：** `POST /api/sync/test/blacklist/add`

**功能：** 测试添加新黑名单（无现有黑名单的情况）

**参数：**
- `plateNumber` (必填): 车牌号，如 "黑A12345"
- `gateNames` (必填): 门名称列表，逗号分隔，如 "化工西门,化肥西门"
- `ownerName` (可选): 车主姓名，默认 "测试车主"
- `startTime` (可选): 开始时间，格式 "yyyy-MM-dd HH:mm:ss"
- `endTime` (可选): 结束时间，格式 "yyyy-MM-dd HH:mm:ss"，为空则为永久黑名单

**测试场景：**

#### 场景1.1：添加临时黑名单（单门）
```
POST http://localhost:8080/api/sync/test/blacklist/add
Content-Type: application/x-www-form-urlencoded

plateNumber=黑A12345
&gateNames=化工西门
&ownerName=张三
&startTime=2026-01-15 00:00:00
&endTime=2026-12-31 23:59:59
```

**预期结果：**
- ✅ 添加黑名单成功
- 黑名单类型名称：`请停车检查（化工西）`
- 类型：临时黑名单

#### 场景1.2：添加临时黑名单（多门）
```
POST http://localhost:8080/api/sync/test/blacklist/add
Content-Type: application/x-www-form-urlencoded

plateNumber=黑A23456
&gateNames=化工西门,化肥西门,复合肥南门
&ownerName=李四
&startTime=2026-01-15 00:00:00
&endTime=2026-12-31 23:59:59
```

**预期结果：**
- ✅ 添加黑名单成功
- 黑名单类型名称：`请停车检查（化工西化肥西复合肥南）`
- 类型：临时黑名单

#### 场景1.3：添加永久黑名单
```
POST http://localhost:8080/api/sync/test/blacklist/add
Content-Type: application/x-www-form-urlencoded

plateNumber=黑A34567
&gateNames=化工西门
&ownerName=王五
```

**预期结果：**
- ✅ 添加黑名单成功
- 黑名单类型名称：`请停车检查（化工西）`
- 类型：永久黑名单

---

### 3. 测试黑名单权限变化（场景2）

**接口地址：** `POST /api/sync/test/blacklist/update-permission`

**功能：** 测试黑名单权限变化（先删除旧黑名单，再添加新黑名单）

**参数：**
- `plateNumber` (必填): 车牌号
- `newGateNames` (必填): 新的门名称列表，逗号分隔
- `ownerName` (可选): 车主姓名，默认 "测试车主"

**前置条件：** 车辆必须已存在黑名单

**测试场景：**

#### 场景2.1：从单门改为多门
```
# 先添加单门黑名单
POST http://localhost:8080/api/sync/test/blacklist/add
plateNumber=黑A12345&gateNames=化工西门&startTime=2026-01-15 00:00:00&endTime=2026-12-31 23:59:59

# 再更新为多门
POST http://localhost:8080/api/sync/test/blacklist/update-permission
plateNumber=黑A12345&newGateNames=化工西门,化肥西门
```

**预期结果：**
- ✅ 权限变化处理成功
- 旧权限：`请停车检查（化工西）`
- 新权限：`化工西门, 化肥西门`
- 操作：先删除旧黑名单，再添加新黑名单

#### 场景2.2：从多门改为单门
```
POST http://localhost:8080/api/sync/test/blacklist/update-permission
plateNumber=黑A12345&newGateNames=化工西门
```

**预期结果：**
- ✅ 权限变化处理成功
- 旧权限：`请停车检查（化工西化肥西）`
- 新权限：`化工西门`
- 操作：先删除旧黑名单，再添加新黑名单

---

### 4. 测试黑名单时间更新（场景3）

**接口地址：** `POST /api/sync/test/blacklist/update-time`

**功能：** 测试临时黑名单时间更新（先删除旧黑名单，再添加新黑名单）

**参数：**
- `plateNumber` (必填): 车牌号
- `newStartTime` (必填): 新的开始时间，格式 "yyyy-MM-dd HH:mm:ss"
- `newEndTime` (必填): 新的结束时间，格式 "yyyy-MM-dd HH:mm:ss"
- `ownerName` (可选): 车主姓名，默认 "测试车主"

**前置条件：** 车辆必须已存在临时黑名单（永久黑名单无法更新时间）

**测试场景：**

#### 场景3.1：延长有效期
```
# 先添加临时黑名单
POST http://localhost:8080/api/sync/test/blacklist/add
plateNumber=黑A12345&gateNames=化工西门&startTime=2026-01-15 00:00:00&endTime=2026-06-30 23:59:59

# 延长有效期到年底
POST http://localhost:8080/api/sync/test/blacklist/update-time
plateNumber=黑A12345&newStartTime=2026-01-15 00:00:00&newEndTime=2026-12-31 23:59:59
```

**预期结果：**
- ✅ 时间更新成功
- 旧时间：`2026-01-15 00:00:00~2026-06-30 23:59:59`
- 新时间：`2026-01-15 00:00:00 ~ 2026-12-31 23:59:59`
- 操作：先删除旧黑名单，再添加新黑名单

#### 场景3.2：缩短有效期
```
POST http://localhost:8080/api/sync/test/blacklist/update-time
plateNumber=黑A12345&newStartTime=2026-01-15 00:00:00&newEndTime=2026-03-31 23:59:59
```

**预期结果：**
- ✅ 时间更新成功
- 操作：先删除旧黑名单，再添加新黑名单

---

### 5. 测试删除黑名单（场景4）

**接口地址：** `POST /api/sync/test/blacklist/delete`

**功能：** 测试删除黑名单（模拟注销状态 DQZT=D）

**参数：**
- `plateNumber` (必填): 车牌号

**前置条件：** 车辆必须已存在黑名单

**测试场景：**

#### 场景4.1：删除黑名单
```
# 先添加黑名单
POST http://localhost:8080/api/sync/test/blacklist/add
plateNumber=黑A12345&gateNames=化工西门&startTime=2026-01-15 00:00:00&endTime=2026-12-31 23:59:59

# 删除黑名单
POST http://localhost:8080/api/sync/test/blacklist/delete
plateNumber=黑A12345
```

**预期结果：**
- ✅ 删除黑名单成功
- 操作：检测到注销状态(DQZT=D)，删除黑名单

---

## 完整测试流程示例

### 测试流程1：完整的生命周期

```bash
# 1. 查询初始状态（应该不存在）
GET /api/sync/test/blacklist/query?plateNumber=黑A99999

# 2. 添加新黑名单（单门，临时）
POST /api/sync/test/blacklist/add
plateNumber=黑A99999&gateNames=化工西门&ownerName=测试用户&startTime=2026-01-15 00:00:00&endTime=2026-06-30 23:59:59

# 3. 查询状态（应该存在）
GET /api/sync/test/blacklist/query?plateNumber=黑A99999

# 4. 更新权限（改为多门）
POST /api/sync/test/blacklist/update-permission
plateNumber=黑A99999&newGateNames=化工西门,化肥西门

# 5. 查询状态（权限应该已更新）
GET /api/sync/test/blacklist/query?plateNumber=黑A99999

# 6. 更新时间（延长有效期）
POST /api/sync/test/blacklist/update-time
plateNumber=黑A99999&newStartTime=2026-01-15 00:00:00&newEndTime=2026-12-31 23:59:59

# 7. 查询状态（时间应该已更新）
GET /api/sync/test/blacklist/query?plateNumber=黑A99999

# 8. 删除黑名单
POST /api/sync/test/blacklist/delete
plateNumber=黑A99999

# 9. 查询状态（应该不存在）
GET /api/sync/test/blacklist/query?plateNumber=黑A99999
```

---

## 注意事项

1. **测试环境：** 这些接口仅用于测试，不应在生产环境使用
2. **车牌号格式：** 建议使用测试车牌号（如 黑A99999），避免影响真实数据
3. **时间格式：** 所有时间参数必须使用格式 `yyyy-MM-dd HH:mm:ss`
4. **门名称：** 必须使用Oracle数据库中的完整门名称（如 "化工西门"），系统会自动转换为ake简化名称
5. **权限合并：** 多个门名称会自动合并为一个黑名单类型名称
6. **永久黑名单：** 不传 `endTime` 参数即为永久黑名单，永久黑名单无法更新时间

---

## 支持的门名称列表

根据设计文档，系统支持以下门名称：

1. 炼油南门
2. 炼油南一
3. 炼油西一
4. 炼油西门
5. 炼油东门
6. 化肥西门
7. 化工西门
8. 化工北门
9. 化工东门
10. 化三南门
11. 复合肥南门
12. 机修厂西一
13. 二罐区正门

**门名称映射规则：**
- Oracle完整名称 → ake简化名称
- 化工西门 → 化工西
- 化肥西门 → 化肥西
- 复合肥南门 → 复合肥南
- 其他门名称去除"门"字后缀

---

## 黑名单类型名称格式

**格式：** `请停车检查（简化名称1+简化名称2+...）`

**示例：**
- 单门：`请停车检查（化工西）`
- 双门：`请停车检查（化工西化肥西）`
- 三门：`请停车检查（化工西化肥西复合肥南）`

---

## 故障排查

### 问题1：接口返回 "测试服务未启用"

**原因：** VehicleBlacklistTestService 未被Spring容器加载

**解决方案：** 确保服务类上有 `@Service` 注解，并且在Spring扫描路径下

### 问题2：添加黑名单失败

**可能原因：**
1. 车辆已存在黑名单（使用查询接口确认）
2. AKE接口连接失败（检查配置文件中的ake.api.base-url）
3. 门名称格式错误（必须使用完整门名称）

**解决方案：**
1. 先删除现有黑名单
2. 检查网络连接和配置
3. 使用支持的门名称列表中的名称

### 问题3：权限变化或时间更新失败

**可能原因：**
1. 车辆不存在黑名单
2. 永久黑名单无法更新时间

**解决方案：**
1. 先添加黑名单
2. 临时黑名单才能更新时间

---

## 技术实现说明

### 核心逻辑

1. **添加新黑名单：** 调用 `processBlacklistSync` 方法，内部会判断无现有黑名单，直接添加
2. **权限变化：** 先删除旧黑名单，再添加新黑名单（因为黑名单类型名称包含权限信息）
3. **时间更新：** 先删除旧黑名单，再添加新黑名单（因为黑名单没有单独的续费接口）
4. **删除黑名单：** 设置 DQZT=D 状态，触发删除逻辑

### 反射调用

测试服务通过反射调用 `DataSyncServiceImpl` 的私有方法 `processBlacklistSync`，这样可以直接测试核心同步逻辑，而不需要从Oracle数据库获取数据。

---

## 后续步骤

测试完成后，可以：

1. 启用自动同步任务（修改 `DataSyncScheduledTask` 的 cron 表达式）
2. 从Oracle数据库同步真实数据
3. 监控同步日志和结果

---

**文档版本：** 1.0  
**创建日期：** 2026-01-15  
**作者：** Kiro AI Assistant
