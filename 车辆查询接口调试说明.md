# 车辆查询接口调试说明

## 问题描述
使用车牌号查询接口时，返回的车辆信息为空。

## 调试步骤

### 1. 先测试列表接口（查看视图中是否有数据）

```bash
# 查询前10条车辆记录
GET http://localhost:8080/api/oracle/vehicle/list?limit=10
```

**目的**：
- 验证视图 `aentranceguard.view_autovalidinfo` 是否可访问
- 查看视图中是否有数据
- 获取实际存在的车牌号用于测试

**预期结果**：
- 如果返回数据，说明视图可访问且有数据
- 记录返回的车牌号，用于下一步测试

### 2. 使用实际车牌号测试查询接口

从步骤1获取到实际车牌号后，使用该车牌号测试查询接口：

```bash
# 使用实际车牌号查询（替换为步骤1中获取的车牌号）
GET http://localhost:8080/api/oracle/vehicle/query?plateNumber=黑E12345
```

### 3. 查看日志输出

重启应用后，查看日志中的以下信息：

```
========== 开始查询车辆有效信息 ==========
车牌号码: xxx
视图总记录数: xxx
视图中的示例车牌号: [xxx, xxx, xxx]
执行SQL查询: 车牌号=xxx
SQL语句: SELECT ...
查询到 X 条车辆记录
```

## 可能的问题和解决方案

### 问题1：视图中没有数据
**现象**：列表接口返回空数组，日志显示"视图总记录数: 0"

**原因**：
- 视图 `aentranceguard.view_autovalidinfo` 中确实没有数据
- 或者视图定义有问题

**解决方案**：
1. 在Oracle数据库中直接执行SQL验证：
```sql
SELECT COUNT(*) FROM aentranceguard.view_autovalidinfo;
SELECT * FROM aentranceguard.view_autovalidinfo WHERE ROWNUM <= 10;
```

2. 检查视图定义是否正确
3. 确认数据是否已经同步到视图中

### 问题2：车牌号格式不匹配
**现象**：列表接口有数据，但按车牌号查询返回空

**原因**：
- 车牌号中可能包含空格或特殊字符
- 大小写敏感问题
- 编码问题（中文车牌）

**解决方案**：
修改查询SQL，使用模糊查询或去除空格：

```sql
-- 方案1：模糊查询
WHERE CPHM LIKE '%' || ? || '%'

-- 方案2：去除空格后比较
WHERE TRIM(CPHM) = TRIM(?)

-- 方案3：忽略大小写
WHERE UPPER(CPHM) = UPPER(?)
```

### 问题3：字段名称错误
**现象**：查询报错，提示字段不存在

**原因**：
- 视图中的字段名与代码中使用的不一致
- 字段名大小写问题

**解决方案**：
1. 在Oracle中查询视图结构：
```sql
DESC aentranceguard.view_autovalidinfo;
```

2. 对比代码中使用的字段名，确保一致

### 问题4：权限问题
**现象**：查询报错，提示表或视图不存在

**原因**：
- 数据库用户没有访问该视图的权限

**解决方案**：
1. 检查数据库连接配置
2. 确认用户是否有访问 `aentranceguard` schema的权限
3. 授予必要的权限：
```sql
GRANT SELECT ON aentranceguard.view_autovalidinfo TO 用户名;
```

## 测试命令

### PowerShell测试命令

```powershell
# 测试列表接口
Invoke-RestMethod -Uri "http://localhost:8080/api/oracle/vehicle/list?limit=10" -Method Get | ConvertTo-Json -Depth 10

# 测试查询接口（替换车牌号）
Invoke-RestMethod -Uri "http://localhost:8080/api/oracle/vehicle/query?plateNumber=黑E12345" -Method Get | ConvertTo-Json -Depth 10
```

### curl测试命令

```bash
# 测试列表接口
curl -X GET "http://localhost:8080/api/oracle/vehicle/list?limit=10"

# 测试查询接口（替换车牌号）
curl -X GET "http://localhost:8080/api/oracle/vehicle/query?plateNumber=黑E12345"
```

## 调试建议

1. **先测试列表接口**：确认视图中是否有数据
2. **查看日志**：重点关注SQL执行日志和返回的记录数
3. **使用实际车牌号**：从列表接口返回的数据中获取真实车牌号进行测试
4. **检查数据库**：直接在Oracle中执行SQL，对比结果
5. **逐步排查**：从简单到复杂，先确认基础功能，再排查具体问题

## 新增接口说明

### 列表查询接口
```
GET /api/oracle/vehicle/list
```

**参数**：
- `limit`（可选）：返回记录数限制，默认10条，最大100条

**用途**：
- 测试视图是否可访问
- 查看视图中的实际数据
- 获取真实车牌号用于测试

**示例**：
```
GET http://localhost:8080/api/oracle/vehicle/list?limit=20
```

## 下一步操作

1. 重启应用
2. 先调用列表接口：`/api/oracle/vehicle/list?limit=10`
3. 查看返回的数据和日志
4. 根据返回的车牌号，调用查询接口测试
5. 如果还有问题，提供日志信息进行进一步排查
