# 黑名单测试 - 快速开始指南

## 前提条件

1. ✅ 项目已编译成功
2. ✅ 应用程序正在运行（端口：8080）
3. ✅ AKE系统接口配置正确（application.yml中的ake.api.base-url）

## 快速测试方法

### 方法1：使用测试脚本（推荐）

1. 双击运行 `test-blacklist.bat`
2. 按照提示按任意键继续每个步骤
3. 观察每个步骤的返回结果

**测试流程：**
```
查询初始状态 → 添加黑名单 → 查询状态 → 更新权限 → 查询状态 → 更新时间 → 查询状态 → 删除黑名单 → 查询状态
```

### 方法2：使用Postman

1. 打开Postman
2. 导入 `黑名单测试接口-Postman集合.json`
3. 按顺序执行请求：
   - 1. 查询黑名单状态
   - 2.1 添加新黑名单-单门临时
   - 3.1 更新权限-单门改多门
   - 4.1 更新时间-延长有效期
   - 5. 删除黑名单

### 方法3：使用curl命令

```bash
# 1. 查询状态
curl "http://localhost:8080/api/sync/test/blacklist/query?plateNumber=黑A99999"

# 2. 添加黑名单
curl -X POST "http://localhost:8080/api/sync/test/blacklist/add?plateNumber=黑A99999&gateNames=化工西门&ownerName=测试用户&startTime=2026-01-15 00:00:00&endTime=2026-06-30 23:59:59"

# 3. 更新权限
curl -X POST "http://localhost:8080/api/sync/test/blacklist/update-permission?plateNumber=黑A99999&newGateNames=化工西门,化肥西门&ownerName=测试用户"

# 4. 更新时间
curl -X POST "http://localhost:8080/api/sync/test/blacklist/update-time?plateNumber=黑A99999&newStartTime=2026-01-15 00:00:00&newEndTime=2026-12-31 23:59:59&ownerName=测试用户"

# 5. 删除黑名单
curl -X POST "http://localhost:8080/api/sync/test/blacklist/delete?plateNumber=黑A99999"
```

### 方法4：使用浏览器（仅查询接口）

直接在浏览器中访问：
```
http://localhost:8080/api/sync/test/blacklist/query?plateNumber=黑A99999
```

## 测试场景说明

### 场景1：添加新黑名单 ✅

**目的：** 测试从无到有添加黑名单

**步骤：**
1. 确认车辆不在黑名单中
2. 调用添加接口
3. 确认添加成功

**预期结果：**
- 返回成功消息
- 黑名单类型名称正确（如：`请停车检查（化工西）`）
- 时间信息正确

### 场景2：权限变化 ✅

**目的：** 测试黑名单权限变化（先删除再添加）

**步骤：**
1. 确认车辆已在黑名单中
2. 调用更新权限接口（改变门名称）
3. 确认权限已更新

**预期结果：**
- 返回成功消息
- 显示旧权限和新权限
- 操作说明：先删除旧黑名单，再添加新黑名单

### 场景3：时间更新 ✅

**目的：** 测试临时黑名单时间更新（先删除再添加）

**步骤：**
1. 确认车辆已在黑名单中（临时）
2. 调用更新时间接口
3. 确认时间已更新

**预期结果：**
- 返回成功消息
- 显示旧时间和新时间
- 操作说明：先删除旧黑名单，再添加新黑名单

**注意：** 永久黑名单无法更新时间

### 场景4：删除黑名单 ✅

**目的：** 测试注销状态删除黑名单

**步骤：**
1. 确认车辆已在黑名单中
2. 调用删除接口
3. 确认删除成功

**预期结果：**
- 返回成功消息
- 操作说明：检测到注销状态(DQZT=D)，删除黑名单

## 验证结果

### 成功标志 ✅

- 返回的JSON中 `success: true`
- `message` 字段包含 "✅" 符号
- 操作说明清晰

### 失败标志 ❌

- 返回的JSON中 `success: false`
- `message` 字段包含 "❌" 符号
- 包含失败原因说明

## 常见问题

### Q1: 接口返回 "测试服务未启用"

**原因：** VehicleBlacklistTestService 未被加载

**解决：** 
1. 检查服务类是否有 `@Service` 注解
2. 重启应用程序
3. 检查Spring扫描路径

### Q2: 添加黑名单失败

**原因：** 
- 车辆已存在黑名单
- AKE接口连接失败
- 门名称格式错误

**解决：**
1. 先查询状态，如果存在则先删除
2. 检查 application.yml 中的 ake.api.base-url 配置
3. 使用正确的门名称（如：化工西门）

### Q3: 更新时间失败，提示"是永久黑名单"

**原因：** 永久黑名单无法更新时间

**解决：** 
1. 删除现有永久黑名单
2. 重新添加临时黑名单（带endTime参数）
3. 再尝试更新时间

### Q4: curl命令中文乱码

**原因：** Windows命令行编码问题

**解决：**
1. 使用测试脚本（已设置UTF-8编码）
2. 或在命令行执行：`chcp 65001`
3. 或使用Postman

## 下一步

测试成功后，可以：

1. ✅ 查看日志文件，确认同步逻辑正确
2. ✅ 在AKE系统中验证黑名单数据
3. ✅ 启用自动同步任务
4. ✅ 从Oracle数据库同步真实数据

## 相关文档

- 📄 `黑名单同步测试接口说明.md` - 详细的接口文档
- 📄 `黑名单测试接口-Postman集合.json` - Postman测试集合
- 📄 `test-blacklist.bat` - 自动化测试脚本
- 📄 `.kiro/specs/daqing-petrochemical-sync/design.md` - 设计文档

## 技术支持

如有问题，请查看：
1. 应用程序日志（nefuSystem.log）
2. 设计文档中的黑名单同步流程说明
3. AKE接口文档

---

**祝测试顺利！** 🎉
