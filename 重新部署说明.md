# 重新部署说明

## 问题原因
服务器上运行的jar包是旧版本，不包含新创建的 `OracleQueryController`、`OracleQueryService` 和 `VehicleValidInfoDTO` 类。

## 解决方案
需要重新打包并部署新的jar包到服务器。

## 部署步骤

### 1. 本地已完成打包
新的jar包已生成在：
```
D:\Daqing Petrochemical Company Demo\target\parkingmanage-0.0.1-SNAPSHOT.jar
```

### 2. 上传新jar包到服务器
将新jar包上传到服务器的部署目录：
```bash
# 假设服务器部署目录为 /usr/local/daqing-petrochemical-company-demo/
scp target/parkingmanage-0.0.1-SNAPSHOT.jar root@服务器IP:/usr/local/daqing-petrochemical-company-demo/
```

### 3. 停止旧服务
```bash
# SSH登录服务器
ssh root@服务器IP

# 查找Java进程
ps -ef | grep parkingmanage

# 停止进程（替换PID为实际进程号）
kill -9 PID

# 或者如果有停止脚本
./stop.sh
```

### 4. 备份旧jar包（可选）
```bash
cd /usr/local/daqing-petrochemical-company-demo/
mv daqing-demo-20260115.jar daqing-demo-20260115.jar.bak
```

### 5. 重命名新jar包
```bash
mv parkingmanage-0.0.1-SNAPSHOT.jar daqing-demo-20260115.jar
```

### 6. 启动新服务
```bash
# 使用nohup后台启动
nohup java -jar daqing-demo-20260115.jar > nohup.out 2>&1 &

# 或者如果有启动脚本
./start.sh
```

### 7. 查看启动日志
```bash
# 实时查看日志
tail -f nohup.out

# 或者查看应用日志
tail -f logs/application.log
```

### 8. 验证服务启动成功
```bash
# 检查进程是否存在
ps -ef | grep parkingmanage

# 检查端口是否监听（端口8459）
netstat -tlnp | grep 8459

# 测试接口
curl http://localhost:8459/api/oracle/vehicle/list?limit=10
```

## 快速部署脚本

创建一个部署脚本 `deploy.sh`：

```bash
#!/bin/bash

# 配置
SERVER_IP="你的服务器IP"
SERVER_USER="root"
DEPLOY_DIR="/usr/local/daqing-petrochemical-company-demo"
JAR_NAME="daqing-demo-20260115.jar"
LOCAL_JAR="target/parkingmanage-0.0.1-SNAPSHOT.jar"

echo "========== 开始部署 =========="

# 1. 上传jar包
echo "1. 上传jar包到服务器..."
scp $LOCAL_JAR $SERVER_USER@$SERVER_IP:$DEPLOY_DIR/parkingmanage-0.0.1-SNAPSHOT.jar

# 2. 在服务器上执行部署命令
echo "2. 在服务器上部署..."
ssh $SERVER_USER@$SERVER_IP << EOF
cd $DEPLOY_DIR

# 停止旧服务
echo "停止旧服务..."
PID=\$(ps -ef | grep $JAR_NAME | grep -v grep | awk '{print \$2}')
if [ -n "\$PID" ]; then
    kill -9 \$PID
    echo "已停止进程: \$PID"
else
    echo "未找到运行中的进程"
fi

# 备份旧jar
if [ -f "$JAR_NAME" ]; then
    echo "备份旧jar包..."
    mv $JAR_NAME ${JAR_NAME}.bak.\$(date +%Y%m%d%H%M%S)
fi

# 重命名新jar
echo "部署新jar包..."
mv parkingmanage-0.0.1-SNAPSHOT.jar $JAR_NAME

# 启动新服务
echo "启动新服务..."
nohup java -jar $JAR_NAME > nohup.out 2>&1 &

# 等待启动
sleep 5

# 检查启动状态
PID=\$(ps -ef | grep $JAR_NAME | grep -v grep | awk '{print \$2}')
if [ -n "\$PID" ]; then
    echo "服务启动成功，PID: \$PID"
else
    echo "服务启动失败，请查看日志"
    tail -20 nohup.out
fi

EOF

echo "========== 部署完成 =========="
```

使用方法：
```bash
chmod +x deploy.sh
./deploy.sh
```

## 验证新功能

部署成功后，测试新接口：

### 1. 测试列表接口
```bash
curl http://服务器IP:8459/api/oracle/vehicle/list?limit=10
```

### 2. 测试查询接口
```bash
curl "http://服务器IP:8459/api/oracle/vehicle/query?plateNumber=车牌号"
```

## 注意事项

1. **端口号**：确认应用使用的端口（日志显示为8459）
2. **防火墙**：确保端口已开放
3. **数据库连接**：确认Oracle数据库连接配置正确
4. **权限**：确认有访问 `aentranceguard.view_autovalidinfo` 视图的权限
5. **日志**：部署后及时查看日志，确认没有错误

## 常见问题

### 问题1：端口被占用
```bash
# 查找占用端口的进程
lsof -i:8459
# 或
netstat -tlnp | grep 8459

# 停止占用端口的进程
kill -9 PID
```

### 问题2：权限不足
```bash
# 确保jar包有执行权限
chmod +x daqing-demo-20260115.jar
```

### 问题3：内存不足
```bash
# 启动时指定内存参数
nohup java -Xms512m -Xmx1024m -jar daqing-demo-20260115.jar > nohup.out 2>&1 &
```

## 回滚方案

如果新版本有问题，可以快速回滚：

```bash
# 停止新服务
kill -9 $(ps -ef | grep daqing-demo-20260115.jar | grep -v grep | awk '{print $2}')

# 恢复旧jar包（找到最新的备份）
mv daqing-demo-20260115.jar.bak.YYYYMMDDHHMMSS daqing-demo-20260115.jar

# 启动旧服务
nohup java -jar daqing-demo-20260115.jar > nohup.out 2>&1 &
```
